<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=1200, initial-scale=1" />
<title>Games that fell off the truck â€” updated</title>
<style>
:root{
  --bg:#0b0f14;
  --muted:#97a0ac;
  --accent:#7c5cf7;
  --glass: rgba(255,255,255,0.03);
  --radius:14px;
  --gap:18px;
  --cols: 5;
  --card-scale: 1;
  --title-size: calc(15px * var(--card-scale));
  --meta-size: calc(12px * var(--card-scale));
  --btn-font: calc(13px * var(--card-scale));
  --btn-padding-vert: calc(8px * var(--card-scale));
  --btn-padding-horiz: calc(10px * var(--card-scale));
  --thumb-aspect: 16 / 9;
}
*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  background:linear-gradient(180deg,#07090c 0%, #0b0f14 100%);
  color:#e6eef8;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto,Arial;
  overflow-x:hidden;
  min-width: 1200px;
}
.app{
  width: 1200px;
  margin: 28px auto;
  padding: 20px;
  transform-origin: top center;
}
header{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:18px;
  flex-wrap:wrap;
}
.brand{
  display:flex;
  gap:12px;
  align-items:center;
}
.square{
  width:56px;
  height:56px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,var(--accent),#4bb6ff);
  font-weight:800;
  color:#06111a;
  font-size:22px;
  font-family:sans-serif;
}
.titleWrap{
  display:flex;
  flex-direction:column;
}
.titleWrap h1{
  font-size:18px;
  margin:0
}
.titleWrap .lead{
  margin:0;
  color:var(--muted);
  font-size:13px
}
.controls{
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}
.search{
  background:var(--glass);
  padding:10px 12px;
  border-radius:999px;
  display:flex;
  gap:8px;
  align-items:center;
  min-width:160px;
  max-width:420px;
}
.search input{
  background:transparent;
  border:0;
  color:inherit;
  outline:none;
  font-size:14px;
  width:100%;
  min-width:0;
}
.sort-wrap{
  display:flex;
  align-items:center;
  gap:8px;
  margin-left:8px
}
.sort-select{
  background:var(--glass);
  border:1px solid rgba(255,255,255,0.04);
  padding:8px;
  border-radius:10px;
  color:inherit;
  font-weight:600
}
.options-container { 
  position: relative; 
  margin-left: auto; 
}
.options-menu { 
  display: none; 
  position: absolute; 
  top: 110%; 
  right: 0; 
  background: var(--glass); 
  backdrop-filter: blur(8px); 
  border-radius: 10px; 
  padding: 12px; 
  min-width: 160px; 
  box-shadow: 0 6px 20px rgba(0,0,0,0.3); 
}
.options-menu.show { 
  display:flex; 
  align-items:center; 
  gap:12px;
}
.options-menu input[type=range]{ 
  -webkit-appearance: none; 
  appearance: none; 
  width:140px; 
  height:8px; 
  background: linear-gradient(90deg,#2b3340,#111418); 
  border-radius:6px; 
  outline:none; 
}
.options-menu input[type=range]::-webkit-slider-thumb{ 
  -webkit-appearance:none; 
  width:20px;
  height:20px;
  border-radius:50%;
  background:linear-gradient(90deg,var(--accent),#4bb6ff);
  box-shadow:0 6px 18px rgba(124,92,247,0.18); 
}
.options-menu input[type=range]::-moz-range-thumb{ 
  width:20px;
  height:20px;
  border-radius:50%;
  background:linear-gradient(90deg,var(--accent),#4bb6ff);
  border:0; 
}
.cols-count{ 
  background:rgba(255,255,255,0.02); 
  border:1px solid rgba(255,255,255,0.04); 
  padding:6px 10px; 
  border-radius:8px; 
  font-weight:800; 
  color:#eaf2ff; 
  min-width:38px; 
  text-align:center; 
  font-size:13px;
}
.device-filters{
  display:flex;
  gap:12px;
  margin-bottom:10px;
  flex-wrap:wrap;
  align-items:center;
}
.device-btn{
  padding:8px 18px;
  border-radius:999px;
  cursor:pointer;
  font-weight:700;
  font-size:14px;
  border:1px solid rgba(255,255,255,0.08);
  background:var(--glass);
  color:var(--muted);
}
.device-btn.active{
  background:linear-gradient(90deg,#4bb6ff,#7c5cf7);
  color:#06111a;
  border:0;
}
.dynamic-filters { 
  display:flex; 
  gap:8px; 
  align-items:center; 
  margin-left: 8px; 
  flex-wrap:wrap; 
}
.filter-btn { 
  padding: 6px 12px; 
  border-radius: 999px; 
  background: rgba(255,255,255,0.03); 
  border: 1px solid rgba(255,255,255,0.04); 
  color: var(--muted); 
  cursor: pointer; 
  font-weight:700;
}
.filter-btn.active { 
  background: linear-gradient(90deg,#4bb6ff,#7c5cf7); 
  color: #06111a; 
  border:0; 
}
.tabs{
  display:flex;
  gap:8px;
  padding:12px 0;
  margin-bottom:12px;
  align-items:center;
  flex-wrap:wrap;
}
.tab-group{
  display:flex;
  gap:8px;
  flex:1;
  align-items:center;
  flex-wrap:wrap;
}
.tab{
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
  padding:8px 12px;
  border-radius:12px;
  color:var(--muted);
  cursor:pointer;
  font-weight:600;
  font-size:13px;
}
.tab.active{
  background:linear-gradient(90deg, rgba(124,92,247,0.12), rgba(75,182,255,0.06));
  border-color:transparent;
  color:#e9f0ff;
  box-shadow:0 6px 20px rgba(16,18,22,0.4)
}
.tab.requests-tab{
  margin-left:auto;
  background:linear-gradient(90deg,#4bb6ff,#7c5cf7);
  color:#06111a;
  border:0;
  box-shadow:0 8px 30px rgba(75,182,255,0.12);
}
.header-owner{
  display:flex;
  gap:8px;
  align-items:center;
}
.header-owner .btn{
  padding:8px 12px;
  border-radius:10px
}
.grid{
  display:grid;
  gap:var(--gap);
  grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
  align-items:start;
  overflow:auto;
  padding-bottom:6px;
  transition:all 0.18s ease;
  width:100%;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  padding:calc(12px * var(--card-scale));
  border-radius:var(--radius);
  display:flex;
  flex-direction:column;
  gap:calc(10px * var(--card-scale));
  border:1px solid rgba(255,255,255,0.03);
  transition:transform 0.18s ease;
}
.thumb{
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  background:linear-gradient(135deg,#07101a,#0b1420);
  box-shadow:inset 0 -20px 40px rgba(0,0,0,0.35);
  aspect-ratio: var(--thumb-aspect);
  width:100%;
  min-height:60px;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transition: opacity 0.25s ease;
}
.card .title{
  font-size:var(--title-size);
  margin:0;
  color:#eaf2ff;
  font-weight:700;
  line-height:1.15
}
.card .meta{
  font-size:var(--meta-size);
  color:var(--muted);
  display:block;
  margin-top:-2px
}
.btn{
  flex:0 0 auto;
  padding:8px 10px;
  border-radius:10px;
  border:0;
  background:transparent;
  color:#cfe3ff;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.04);
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-height:32px;
}
.card .btn{
  flex:1 1 0;
  padding: var(--btn-padding-vert) var(--btn-padding-horiz);
  font-size: var(--btn-font);
  min-height: calc(32px * var(--card-scale));
  min-width: 0;
}
.btn.primary{
  background:linear-gradient(90deg,var(--accent),#4bb6ff);
  color:#06111a;
  box-shadow:0 8px 30px rgba(124,92,247,0.12);
  border:0
}
.btn.ghost{
  background:transparent;
  border:1px solid rgba(255,255,255,0.03)
}
.btn.small{
  padding:6px 8px;
  font-size:12px;
  border-radius:8px
}
.extra-buttons{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  flex:1 1 100%
}
.card .buttons { 
  display:flex; 
  gap:8px; 
  align-items:center; 
  flex-wrap:wrap; 
  width:100%; 
}
.request-form { 
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03)); 
  border-radius: var(--radius); 
  padding: 20px; 
  border: 1px solid rgba(255,255,255,0.05); 
  margin-bottom: 24px;
}
.form-group { 
  margin-bottom: 16px; 
}
.form-control { 
  width:100%; 
  padding:10px 12px; 
  background: rgba(255,255,255,0.03); 
  border:1px solid rgba(255,255,255,0.05); 
  border-radius:10px; 
  color:#eaf2ff; 
}
.requests-grid { 
  display: grid; 
  gap: var(--gap); 
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
}
.request-card { 
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); 
  padding: 16px; 
  border-radius: var(--radius); 
  border: 1px solid rgba(255,255,255,0.03); 
  position: relative;
}
.request-title{
  font-size:16px;
  margin:8px 0;
  font-weight:700;
  color:#eaf2ff"
}
.request-meta { 
  color: var(--muted); 
  font-size:13px; 
  margin-bottom: 10px; 
  display:flex; 
  gap:12px; 
  align-items:center; 
}
.request-category { 
  display:inline-block; 
  padding:4px 10px; 
  background: rgba(124,92,247,0.1); 
  border-radius:6px; 
  color:#c6b3ff; 
  font-weight:700; 
  font-size:13px;
}
.request-body{
  font-size:14px;
  color:#d0d8e3;
  line-height:1.4;
  margin-bottom:8px
}
.request-status { 
  position:absolute; 
  top:16px; 
  right:16px; 
  font-size:11px; 
  padding:6px 8px; 
  border-radius:6px; 
  font-weight:700; 
}
.status-open { 
  background: rgba(46, 204, 113, 0.12); 
  color: #2ecc71; 
  border:1px solid rgba(46,204,113,0.08) 
}
.status-closed { 
  background: rgba(231, 76, 60, 0.12); 
  color: #e74c3c; 
  border:1px solid rgba(231,76,60,0.08) 
}
.footer{
  color:var(--muted);
  font-size:12px;
  margin-top:14px;
  text-align:center
}
.section-category{
  margin-bottom:28px;
  padding:18px;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.02)
}
.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px
}
.section-title{
  font-size:20px;
  font-weight:800;
  color:#eaf2ff
}
.section-controls{
  display:flex;
  gap:8px;
  align-items:center
}
.cat-grid{
  display:grid;
  gap:14px;
  grid-template-columns:repeat(5,1fr)
}
.cat-pagination{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:12px;
  justify-content:flex-end
}
.slider{
  width:100%;
  height:260px;
  border-radius:12px;
  overflow:hidden;
  position:relative;
  background:linear-gradient(135deg,#111218,#0b0f14);
  margin-bottom:18px;
  display:flex;
  align-items:center;
  justify-content:center
}
.slide{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px
}
.slide.active{
  display:flex
}
.slide .slide-inner{
  width:100%;
  height:100%;
  display:flex;
  gap:16px;
  align-items:center
}
.slide .thumb{
  flex:0 0 45%;
  height:100%
}
.slide .info{
  flex:1 1 auto;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center
}
.slider-controls{
  position:absolute;
  right:14px;
  top:14px;
  display:flex;
  gap:8px
}
.slider-dots{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:12px;
  display:flex;
  gap:8px
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:rgba(255,255,255,0.12);
  cursor:pointer
}
.dot.active{
  background:linear-gradient(90deg,#4bb6ff,#7c5cf7)
}
.owner-badge{
  background:linear-gradient(90deg,#ffd166,#ff9a00);
  color:#06111a;
  padding:6px 10px;
  border-radius:999px;
  font-weight:800
}
.edit-modal{
  position:fixed;
  left:0;
  top:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999
}
.edit-panel{
  width:940px;
  max-width:96%;
  background:#0f1720;
  padding:18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.04);
  color:#eaf2ff
}
.edit-panel h3{
  margin-top:0
}
.checkbox-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
  max-height:360px;
  overflow:auto;
  padding:8px;
  background:rgba(255,255,255,0.01);
  border-radius:8px
}
.small-muted{
  color:var(--muted);
  font-size:13px
}
@keyframes spin { 
  from { transform: rotate(0deg); } 
  to { transform: rotate(360deg); } 
}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="square">ðŸŽ®</div>
        <div class="titleWrap">
          <h1>Games that fell off the truck</h1>
          <div class="lead">Games rescued from the wild</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="controls">
          <div style="display:flex;align-items:center">
            <div class="search" title="Search by name">
              ðŸ”Ž <input id="search" placeholder="Search by name..." />
            </div>
            <div class="sort-wrap">
              <label for="sortSelect" style="font-size:13px;color: var(--muted)">Sort:</label>
              <select id="sortSelect" class="sort-select" title="Sort games">
                <option value="default">Default</option>
                <option value="alpha">Alphabetical</option>
                <option value="recent">Most recent</option>
              </select>
            </div>
          </div>
          <div class="options-container">
            <button id="optionsBtn" class="btn ghost" type="button">âš™ Options</button>
            <div id="optionsMenu" class="options-menu" aria-hidden="true">
              <input type="range" id="zoomSlider" min="1" max="8" step="1" />
              <div class="cols-count" id="colsCount">5</div>
            </div>
          </div>
        </div>
        <div class="header-owner" id="ownerHeaderArea" style="display:none;margin-left:12px">
          <div class="owner-badge">Owner</div>
          <button id="openEditorBtn" class="btn primary" style="margin-left:8px">Edit Slides</button>
        </div>
      </div>
    </header>

    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
      <div class="device-filters" id="deviceFilters">
        <button class="device-btn active" data-device="pc" id="btnPC">PC</button>
        <button class="device-btn" data-device="android" id="btnAndroid">Android</button>
      </div>
      <!-- container where TXT filters will be created dynamically -->
      <div class="dynamic-filters" id="dynamicFilters" aria-live="polite"></div>
    </div>

    <nav class="tabs" id="tabs">
      <div class="tab-group" id="tabGroup">
        <button class="tab active" data-cat="all" type="button">All</button>
        <button class="tab" data-cat="Indie" type="button">Indie</button>
        <button class="tab" data-cat="AAA" type="button">AAA</button>
        <button class="tab" data-cat="NSFW" type="button">NSFW</button>
      </div>
      <button class="tab requests-tab" data-cat="requests" id="requestsTab" type="button">Requests</button>
    </nav>

    <main>
      <!-- Large slider (appears in All when owner is logged in and there are slides) -->
      <div id="ownerSliderWrap" style="display:none;margin-bottom:18px">
        <div class="slider" id="ownerSlider" aria-live="polite">
          <div class="slider-controls" id="sliderControls" style="display:flex">
            <button id="prevSlideBtn" class="btn small">â—€</button>
            <button id="nextSlideBtn" class="btn small">â–¶</button>
          </div>
          <div id="slidesContainer"></div>
          <div class="slider-dots" id="sliderDots"></div>
        </div>
      </div>

      <section id="allSections" style="display:block"></section>

      <section id="gridWrap" style="display:none">
        <section id="grid" class="grid" aria-live="polite"></section>
      </section>

      <section id="requestSection" style="display: none;">
        <!-- request form (kept, with GitHub login) -->
        <form class="request-form" id="requestForm" novalidate>
          <h2>Request a Game</h2>
          <p style="margin-bottom: 16px; color: var(--muted);">Submit your request for a new game to be added to the collection (requires GitHub login).</p>
          <div id="githubLoginSection" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
            <div id="loginForm" style="display: block;">
              <h3 style="margin: 0 0 12px 0; color: #eaf2ff; font-size: 16px;">GitHub Authentication</h3>
              <p style="margin: 0 0 16px 0; color: var(--muted); font-size: 14px;">Login with your GitHub Personal Access Token to submit and manage requests</p>
              <div class="form-group" style="margin-bottom: 12px;">
                <label for="githubUsername" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">GitHub Username*</label>
                <input type="text" id="githubUsernameInput" class="form-control" placeholder="your-github-username" required>
              </div>
              <div class="form-group" style="margin-bottom: 16px;">
                <label for="githubToken" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">Personal Access Token*</label>
                <input type="password" id="githubTokenInput" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                <small style="display: block; margin-top: 4px; color: var(--muted); font-size: 12px;">
                  <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--accent); text-decoration: none;">Create a token</a> with 'repo' and 'user' scope
                </small>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button id="githubLoginBtn" class="btn primary" type="button">Login</button>
                <div id="loginSpinner" style="display: none;">
                  <div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
              </div>
              <div id="loginError" style="display: none; margin-top: 12px; padding: 10px; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.2); border-radius: 6px; color: #e74c3c;"></div>
            </div>
            <div id="loginSuccess" style="display: none;">
              <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <img id="userAvatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; display: none;">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center;" id="defaultAvatar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  </div>
                  <div>
                    <p style="margin: 0; color: #2ecc71; font-weight: 700; font-size: 14px;">Logged in as <span id="githubUsername"></span></p>
                    <p style="margin: 0; color: var(--muted); font-size: 12px;">You can submit and manage requests</p>
                  </div>
                </div>
                <button id="githubLogoutBtn" class="btn ghost small" type="button">Logout</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="requestTitle">Title*</label>
            <input type="text" id="requestTitle" class="form-control" placeholder="Name of the game, etc." required>
          </div>
          <div class="form-group">
            <label for="requestCategory">Category*</label>
            <select id="requestCategory" class="form-control" required>
              <option value="">Select a category</option>
              <option value="Indie">Indie</option>
              <option value="AAA">AAA</option>
              <option value="NSFW">NSFW</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="requestLink">Link*</label>
            <input type="url" id="requestLink" class="form-control" placeholder="https://store.steampowered.com/app/..." required>
            <small style="display: block; margin-top: 4px; color: var(--muted);">Where can we find this game?</small>
          </div>
          <div class="form-group">
            <label for="requestDescription">Description</label>
            <textarea id="requestDescription" class="form-control" rows="4" placeholder="Provide any additional details..."></textarea>
          </div>
          <div class="form-actions" style="display:flex;gap:8px;align-items:center;">
            <button id="submitRequest" class="btn primary" type="button">Submit Request</button>
            <a href="https://github.com/LucyYuih/Games-that-fell-off-the-truck/issues" target="_blank" class="btn ghost">View All Requests</a>
          </div>
        </form>

        <div class="request-divider" style="height:18px;"></div>
        <h2>Requests</h2>
        <div class="request-view-tabs" style="display: flex; gap: 8px; margin: 12px 0;">
          <button class="request-view-tab active" id="allRequestsViewTab" type="button">All Requests</button>
          <button class="request-view-tab" id="myRequestsViewTab" style="display: none;" type="button">My Requests</button>
        </div>
        <div class="request-tabs" role="tablist" aria-label="Request status tabs" style="margin-bottom:12px;">
          <button class="request-tab active" id="openRequestsTab" type="button">Open</button>
          <button class="request-tab" id="closedRequestsTab" type="button">Closed</button>
        </div>
        <p id="requestsDescription" style="margin-bottom: 16px; color: var(--muted);">Recent requests from the community.</p>
        <div class="requests-grid" id="requestsGrid"></div>
      </section>
    </main>
    <div class="footer">@LucyYuih</div>
  </div>

  <!-- Editor modal (appears only for owner) -->
  <div id="editModal" style="display:none" class="edit-modal" role="dialog" aria-modal="true">
    <div class="edit-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Slide Editor (select up to 10 per device)</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small-muted" style="margin-right:8px">Device:</label>
          <select id="editorDeviceSelect" class="form-control" style="width:120px">
            <option value="pc">PC</option>
            <option value="android">Android</option>
          </select>
          <button id="closeEditorBtn" class="btn ghost small">Close</button>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
        <div>
          <label class="small-muted">Interval (seconds)</label><br/>
          <input id="editorInterval" type="number" min="2" max="60" class="form-control" style="width:100px" />
        </div>
        <div>
          <label class="small-muted">Save</label><br/>
          <button id="saveSlidesBtn" class="btn primary">Save to repo</button>
        </div>
        <div style="margin-left:auto"><span class="small-muted">Save will fail if token doesn't allow write; there will be local fallback</span></div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.04);margin:12px 0">

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <input id="editorSearch" placeholder="Search game..." class="form-control" style="flex:1" />
        <div class="small-muted" id="selectedCount">Selected: 0/10</div>
      </div>

      <div class="checkbox-grid" id="editorCheckboxGrid"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="clearSlidesBtn" class="btn ghost">Clear</button>
        <button id="saveLocalBtn" class="btn small">Save local</button>
      </div>
    </div>
  </div>

<script>
/* ========= Configs / constants ========= */
const REPO = 'LucyYuih/Games-that-fell-off-the-truck';
const FILES = {
  pc: 'https://raw.githubusercontent.com/LucyYuih/Games-that-fell-off-the-truck/main/games.txt',
  android: 'https://raw.githubusercontent.com/LucyYuih/Games-that-fell-off-the-truck/main/gamesandroid.txt'
};
const SLIDES_FILE_BASE = 'slides'; // creates slides_pc.txt / slides_android.txt in repo

let currentDevice = 'pc';
let activeFilter = null;
let githubToken = null;
let githubUser = null;
let allItemsByDevice = { pc: [], android: [] }; // cache
let slidesData = { pc: {items:[], interval:5}, android: {items:[], interval:5} }; // object with list of titles/ids and interval
let sliderTimer = null;
let currentSlideIndex = 0;

/* ---------- utilities (Caesar decoding etc) ---------- */
function caesarDecodeLettersDigits(text, shift) {
  const sLetters = ((shift % 26) + 26) % 26;
  const sDigits = ((shift % 10) + 10) % 10;
  let out = '';
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const code = ch.charCodeAt(0);
    if (code >= 97 && code <= 122) {
      const base = 97;
      const dec = (code - base - sLetters + 26) % 26 + base;
      out += String.fromCharCode(dec);
    } else if (code >= 65 && code <= 90) {
      const base = 65;
      const dec = (code - base - sLetters + 26) % 26 + base;
      out += String.fromCharCode(dec);
    } else if (code >= 48 && code <= 57) {
      const base = 48;
      const dec = (code - base - sDigits + 10) % 10 + base;
      out += String.fromCharCode(dec);
    } else {
      out += ch;
    }
  }
  return out;
}
function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m]; });}
function capitalize(s){ return s && s.length ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

/* ========= robust heuristics to detect URL / category ========= */
function isUrlLine(s){
  if(!s) return false;
  const t = s.trim();
  if(/:\/\//i.test(t)) return true;
  if(/^\s*www\./i.test(t)) return true;
  if(/^\s*https?:\/\//i.test(t)) return true;
  if(/[^\s\/]+\.(?:com|net|org|io|gg|app|store|dev|co|br|ru|de|jp|fr|uk|edu)(\/|$)/i.test(t)) return true;
  if(/\.[a-z]{2,6}\/?/i.test(t) && /\/+/.test(t)) return true;
  return false;
}
function isCategoryCandidate(s){
  if(!s) return false;
  const t = s.trim();
  if(t.length === 0) return false;
  if(t.length > 70) return false;
  if(isUrlLine(t)) return false;
  if(/[:\/\?=&]/.test(t)) return false;
  if(!/^[\p{L}\p{N}\s\-'.,()&:!]+$/u.test(t)) return false;
  if(/^[0-9]+$/.test(t)) return false;
  return true;
}

/* ========= main parser (kept/extended) ========= */
function extractFiltersFromTxt(txt) {
  const lines = txt.split(/\r?\n/);
  const filtersSet = new Set();
  for (let raw of lines) {
    const line = raw.replace(/\u00A0/g,' ').trim();
    if (!line) continue;
    const m = line.match(/^(filters?|filtros|tags?|categories?)\s*[:\-]\s*(.+)$/i);
    if (m) {
      const list = m[2].split(',').map(x => x.trim()).filter(Boolean);
      for (const it of list) filtersSet.add(it);
    }
  }
  return Array.from(filtersSet);
}
function extractCategoriesFromTxt(txt) {
  const lines = txt.split(/\r?\n/);
  const cats = [];
  function addCat(name){
    if(!name) return;
    const nm = name.trim();
    if(!nm) return;
    if(!cats.includes(nm)) cats.push(nm);
  }
  for(let i=0;i<lines.length;i++){
    const raw = (lines[i] || '').replace(/\u00A0/g,' ').trim();
    if(!raw) continue;
    if(/^[-]{3,}$/.test(raw)) continue;
    const lower = raw.toLowerCase();
    if(lower.startsWith('image') || lower.startsWith('original') || lower.startsWith('filters') || lower.startsWith('tags')) continue;
    let j=i+1; while(j<lines.length && (!lines[j] || !lines[j].trim())) j++;
    let next = (j<lines.length) ? (lines[j] || '').replace(/\u00A0/g,' ').trim() : null;
    let k=j+1; while(k<lines.length && (!lines[k] || !lines[k].trim())) k++;
    let nextNext = (k<lines.length) ? (lines[k] || '').replace(/\u00A0/g,' ').trim() : null;
    if(!isCategoryCandidate(raw)) continue;
    if(nextNext && isUrlLine(nextNext)) { addCat(capitalize(raw)); continue; }
    let prevIndex=i-1; while(prevIndex>=0 && (!lines[prevIndex] || !lines[prevIndex].trim())) prevIndex--;
    let prev = (prevIndex>=0) ? (lines[prevIndex]||'').replace(/\u00A0/g,' ').trim() : null;
    if(prev && /^[-]{3,}$/.test(prev)) { addCat(capitalize(raw)); continue; }
    if(next && /^[-]{3,}$/.test(next)) { addCat(capitalize(raw)); continue; }
    if(next && !isUrlLine(next)) { addCat(capitalize(raw)); continue; }
  }
  if(cats.length === 0) {
    ['Indie','AAA','NSFW'].forEach(c=>{ if(!cats.includes(c)) cats.push(c); });
  }
  return cats;
}
function parseGamesTxt(txt){
  const lines = txt.split(/\r?\n/);
  let currentCategory = null;
  const items = [];
  let block = [];
  function flushBlock(){
    if(block.length===0) return;
    let item = parseBlock(block, currentCategory);
    if(item) items.push(item);
    block=[];
  }
  for(let i=0;i<lines.length;i++){
    const rawLine = lines[i] || '';
    const line = rawLine.replace(/\u00A0/g,' ').trim();
    if(!line){
      flushBlock();
      continue;
    }
    if(line.startsWith('#')) continue;
    const lower = line.toLowerCase();
    if(/^[-]{3,}$/.test(line)) { flushBlock(); continue; }
    if(!lower.startsWith('image') && !lower.startsWith('original') && !lower.startsWith('filters') && !lower.startsWith('tags')){
      let j=i+1; while(j<lines.length && (!lines[j] || !lines[j].trim())) j++;
      let next = (j<lines.length) ? (lines[j] || '').replace(/\u00A0/g,' ').trim() : null;
      let k=j+1; while(k<lines.length && (!lines[k] || !lines[k].trim())) k++;
      let nextNext = (k<lines.length) ? (lines[k] || '').replace(/\u00A0/g,' ').trim() : null;
      let p = i-1; while(p>=0 && (!lines[p] || !lines[p].trim())) p--;
      let prev = (p>=0) ? (lines[p] || '').replace(/\u00A0/g,' ').trim() : null;
      if(isCategoryCandidate(line)){
        if(nextNext && isUrlLine(nextNext) && !isUrlLine(line)){
          flushBlock();
          currentCategory = capitalize(line);
          continue;
        }
        if(prev && /^[-]{3,}$/.test(prev)) { flushBlock(); currentCategory = capitalize(line); continue; }
        if(next && /^[-]{3,}$/.test(next)) { flushBlock(); currentCategory = capitalize(line); continue; }
        if(next && !isUrlLine(next)) {
          flushBlock();
          currentCategory = capitalize(line);
          continue;
        }
      }
    }
    block.push(line);
  }
  flushBlock();
  return items;
}
function parseBlock(blockLines, currentCategory){
  if(blockLines.length === 0) return null;
  const lines = blockLines.filter(l => l && l.trim() !== '');
  const title = lines[0].trim();
  let downloadUrl = null, pageUrl = null, imageUrl = null;
  let gotOriginal = false;
  const urls = [];
  const tags = [];
  const extractUrls = (str) => {
    const m = str.match(/[A-Za-z][A-Za-z0-9+.\-]*:\/\/[^\s)]+/g);
    return m || [];
  };
  for(let i=1;i<lines.length;i++){
    const ln = lines[i].trim();
    const imageLineMatch = ln.match(/^\s*image\s*[:\-]?\s*(https?:\/\/[^\s)]+)\s*$/i);
    if(imageLineMatch){
      imageUrl = imageLineMatch[1];
      continue;
    }
    if(ln.toLowerCase() === 'original'){ gotOriginal = true; continue; }
    const tagMatch = ln.match(/^(filters?|filtros|tags?)\s*[:\-]\s*(.+)$/i);
    if(tagMatch){
      const local = tagMatch[2].split(',').map(x=>x.trim()).filter(Boolean);
      for(const t of local) if(!tags.includes(t)) tags.push(t);
      continue;
    }
    const found = extractUrls(ln);
    if(found.length){
      for(const u of found) urls.push(u);
    } else {
      const domainLike = ln.match(/([^\s]+\.[a-z]{2,}(\/[^\s]*)?)/i);
      if(domainLike && domainLike[1]) {
        urls.push(domainLike[1]);
      }
    }
  }
  if(urls.length > 0){
    downloadUrl = urls[0];
    if(urls.length >= 2) pageUrl = urls[1];
    if(urls.length >= 3) imageUrl = imageUrl || urls[2];
    if(!imageUrl){
      const last = urls[urls.length - 1];
      if(/\.(png|jpe?g|webp|gif|svg)(\?|$)/i.test(last)) imageUrl = last;
    }
  }
  let category = currentCategory || 'Indie';
  const normalizedTags = tags.map(t => t.trim()).filter(Boolean);
  return { title, category, downloadUrl, pageUrl, imageUrl, rawLines: lines, tags: normalizedTags };
}

/* ========= UI helpers (filter buttons, dynamic tabs) ========= */
function createFilterButtons(filters) {
  const container = document.getElementById('dynamicFilters');
  container.innerHTML = '';
  if(!filters || filters.length === 0) return;
  const clearBtn = document.createElement('button');
  clearBtn.className = 'filter-btn';
  clearBtn.textContent = 'Show all';
  clearBtn.onclick = function(){
    activeFilter = null;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    clearBtn.classList.add('active');
    applyCurrentViewRender();
  };
  container.appendChild(clearBtn);
  clearBtn.classList.add('active');

  for(const f of filters){
    const b = document.createElement('button');
    b.className = 'filter-btn';
    b.textContent = f;
    b.dataset.filter = f;
    b.onclick = function(){
      const wasActive = b.classList.contains('active');
      document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
      if(!wasActive){
        b.classList.add('active');
        activeFilter = b.dataset.filter;
      } else {
        activeFilter = null;
        clearBtn.classList.add('active');
      }
      applyCurrentViewRender();
    };
    container.appendChild(b);
  }
}

function createCategoryTabs(categories){
  const tabGroup = document.getElementById('tabGroup');
  tabGroup.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.dataset.cat = 'all';
  allBtn.type = 'button';
  allBtn.textContent = 'All';
  tabGroup.appendChild(allBtn);

  const seen = new Set();
  for(const c of categories){
    if(!c) continue;
    const label = c.trim();
    if(!label) continue;
    if(seen.has(label)) continue;
    seen.add(label);
    const b = document.createElement('button');
    b.className = 'tab';
    b.dataset.cat = label;
    b.type = 'button';
    b.textContent = label;
    tabGroup.appendChild(b);
  }
  ['Indie','AAA','NSFW'].forEach(d=> {
    if(!seen.has(d)) {
      const b = document.createElement('button');
      b.className = 'tab';
      b.dataset.cat = d;
      b.type = 'button';
      b.textContent = d;
      tabGroup.appendChild(b);
    }
  });
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  const all = document.querySelector('.tab[data-cat="all"]');
  if(all) all.classList.add('active');
}

/* ========= card creation (improved to always use imageUrl if available) ========= */
function makeCard(item){
  const el = document.createElement('div');
  el.className='card';
  el.dataset.title=item.title.toLowerCase();
  el.dataset.category=item.category;
  el.dataset.tags = (item.tags && item.tags.length) ? item.tags.join(',').toLowerCase() : '';
  const thumb = document.createElement('div');
  thumb.className='thumb';
  
  // Always use imageUrl if available, regardless of device
  if(item.imageUrl){
    const img = document.createElement('img');
    img.src = item.imageUrl;
    img.alt = '';
    thumb.appendChild(img);
  } else {
    // Fallback to platform-specific images only if no imageUrl
    if(currentDevice==='pc' && item.pageUrl && item.pageUrl.includes('steampowered.com/app/')){
      const appIdMatch = item.pageUrl.match(/\/app\/(\d+)/);
      if(appIdMatch){
        const appId = appIdMatch[1];
        const img = document.createElement('img');
        img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/header.jpg`;
        img.alt = '';
        thumb.appendChild(img);
      }else{
        thumb.textContent = 'No Image';
      }
    }
    else if(currentDevice==='android'){
      if(item.pageUrl && item.pageUrl.includes('play.google.com/store/apps')){
        const img = document.createElement('img');
        img.src = 'https://play-lh.googleusercontent.com/ogw/AOLn63E8Koz5A9iVgX2WWv7jDrXw7W3wYw6iUP3Fa9fN=s32-c-mo';
        img.alt = '';
        thumb.appendChild(img);
      }else{
        thumb.textContent = 'No Image';
      }
    }
    else{
      thumb.textContent = 'No Image';
    }
  }

  const titleDiv = document.createElement('div');
  const metaText = item.tags && item.tags.length ? `${item.category} Â· ${item.tags.join(', ')}` : `${item.category}`;
  titleDiv.innerHTML = `<div class="title">${escapeHtml(item.title)}</div><div class="meta">${escapeHtml(metaText)}</div>`;
  const buttons = document.createElement('div');
  buttons.className='buttons';
  
  // Apply Caesar decoding to download URLs
  let decodedDownloadUrl = null;
  if(item.downloadUrl){
    try {
      decodedDownloadUrl = caesarDecodeLettersDigits(item.downloadUrl, 3);
      if(!/[A-Za-z][A-Za-z0-9+.\-]*:\/\//.test(decodedDownloadUrl) && /^[^\s]+\.[a-z]{2,}/i.test(decodedDownloadUrl)) {
        decodedDownloadUrl = 'http://' + decodedDownloadUrl;
      }
    } catch (e) {
      decodedDownloadUrl = item.downloadUrl;
    }
    
    const aDl=document.createElement('a');
    aDl.className='btn primary';
    aDl.href = decodedDownloadUrl;
    aDl.target='_blank';
    aDl.rel='noopener';
    aDl.textContent='Download';
    buttons.appendChild(aDl);
  }
  
  if(currentDevice==='pc' && item.pageUrl && item.pageUrl.includes('steampowered.com/app/')){
    const aSteam = document.createElement('a');
    aSteam.className='btn ghost';
    aSteam.href=item.pageUrl;
    aSteam.target='_blank';
    aSteam.rel='noopener';
    aSteam.textContent='Steam Page';
    buttons.appendChild(aSteam);
  }
  if(currentDevice==='android' && item.pageUrl && item.pageUrl.includes('play.google.com/store/apps')){
    const aPlay = document.createElement('a');
    aPlay.className='btn ghost';
    aPlay.href=item.pageUrl;
    aPlay.target='_blank';
    aPlay.rel='noopener';
    aPlay.textContent='Google Play Page';
    buttons.appendChild(aPlay);
  }
  el.appendChild(thumb);
  el.appendChild(titleDiv);
  el.appendChild(buttons);
  return el;
}

/* ========= renderers ========= */

/* Render when tab is not "All": normal grid (modifiable columns) */
function renderGrid(items){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  window.currentItems=items;
  const frag=document.createDocumentFragment();
  for(const it of items) frag.appendChild(makeCard(it));
  grid.appendChild(frag);
  applySortAndReorder();
  filterAndShowGrid();
}

/* Render when "All" â€” creates sections by category; each section has its pagination (10 per page, 5 columns x 2 rows) */
function renderAllSections(allItems){
  const wrapper=document.getElementById('allSections');
  wrapper.innerHTML='';
  // group by category preserving order
  const orderedCats = [];
  const map = {};
  allItems.forEach(it=>{
    if(!map[it.category]) { map[it.category]=[]; orderedCats.push(it.category); }
    map[it.category].push(it);
  });
  // For each category, create section
  orderedCats.forEach(cat=>{
    const items = map[cat] || [];
    const sec = document.createElement('div');
    sec.className = 'section-category';
    const header = document.createElement('div');
    header.className='section-header';
    header.innerHTML = `<div class="section-title">${escapeHtml(cat)}</div>`;
    const controls = document.createElement('div');
    controls.className='section-controls';
    const info = document.createElement('div'); info.className='small-muted'; info.textContent = `${items.length} game(s)`;
    controls.appendChild(info);
    header.appendChild(controls);
    sec.appendChild(header);

    // grid container for pages (we will hold pages as children, only one visible)
    const pagesWrapper = document.createElement('div');
    pagesWrapper.className = 'pages-wrapper';
    const perPage = 10;
    const pageCount = Math.max(1, Math.ceil(items.length / perPage));
    for(let p=0;p<pageCount;p++){
      const page = document.createElement('div');
      page.className = 'cat-page';
      page.style.display = p===0 ? '' : 'none';
      const grid = document.createElement('div');
      grid.className = 'cat-grid';
      const start = p*perPage;
      const slice = items.slice(start, start+perPage);
      slice.forEach(it=>{
        const card = makeCard(it);
        grid.appendChild(card);
      });
      page.appendChild(grid);
      pagesWrapper.appendChild(page);
    }

    sec.appendChild(pagesWrapper);

    // pagination controls (if more than 1 page)
    const pagination = document.createElement('div');
    pagination.className = 'cat-pagination';
    if(pageCount > 1){
      const prev = document.createElement('button'); prev.className='btn small'; prev.textContent='â—€';
      const next = document.createElement('button'); next.className='btn small'; next.textContent='â–¶';
      const pageIndicator = document.createElement('div'); pageIndicator.className='small-muted'; pageIndicator.textContent='1 / ' + pageCount;
      let current = 0;
      prev.onclick = function(){
        if(current <= 0) return;
        pagesWrapper.children[current].style.display='none';
        current--;
        pagesWrapper.children[current].style.display='';
        pageIndicator.textContent = (current+1) + ' / ' + pageCount;
      };
      next.onclick = function(){
        if(current >= pageCount-1) return;
        pagesWrapper.children[current].style.display='none';
        current++;
        pagesWrapper.children[current].style.display='';
        pageIndicator.textContent = (current+1) + ' / ' + pageCount;
      };
      pagination.appendChild(prev);
      pagination.appendChild(pageIndicator);
      pagination.appendChild(next);
    }
    sec.appendChild(pagination);
    wrapper.appendChild(sec);
  });
  // After render, apply local search/filter only if an active filter exists
  applySearchAndFilterAll();
}

/* Apply column variable only on grid mode (when tab != all)
   The user wanted columns options to affect only when filter/tab especÃ­fico estÃ¡ selecionado â€” implementamos: 
   - If active tab is 'all', ignore cols and force 5 columns for category blocks (done in CSS)
   - Otherwise apply --cols
*/
function applyColumns(cols){
  cols = Math.max(1, Math.min(8, parseInt(cols)));
  // only apply if active tab != 'all'
  const activeTab = getActiveTab().toLowerCase();
  if(activeTab === 'all'){
    // don't change : keep default --cols for grid but All uses its own layout
    document.documentElement.style.setProperty('--cols', 5);
  } else {
    document.documentElement.style.setProperty('--cols', cols);
    localStorage.setItem('gridColumns', cols);
  }
}

/* ========= filtering and search ========= */
function filterAndShowGrid(){
  const query = (document.getElementById('search').value || '').toLowerCase();
  const catBtn = document.querySelector('.tab.active');
  let cat = catBtn ? catBtn.dataset.cat : 'all';
  cat = cat.toLowerCase();
  const grid = document.getElementById('grid');
  Array.from(grid.children).forEach(card => {
    const cardCat = (card.dataset.category || '').toLowerCase();
    const matchTitle = card.dataset.title.includes(query);
    const matchCat = (cat === 'all') || (cardCat === cat);
    let matchFilter = true;
    if(activeFilter){
      const tags = (card.dataset.tags || '').toLowerCase();
      matchFilter = tags.split(',').map(x=>x.trim()).filter(Boolean).includes(activeFilter.toLowerCase());
    }
    card.style.display = (matchTitle && matchCat && matchFilter) ? '' : 'none';
  });
}

/* For All layout: apply search and optional activeFilter by hiding cards that don't match.
   Behavior: when a filter is selected or search used while in All, we still show category header but hide cards that don't match.
   If filter is active and a category ends up empty, we keep only categories with at least one visible card so UX is clean.
*/
function applySearchAndFilterAll(){
  const query = (document.getElementById('search').value || '').toLowerCase();
  const wrap = document.getElementById('allSections');
  const sections = Array.from(wrap.querySelectorAll('.section-category'));
  sections.forEach(sec=>{
    const cards = Array.from(sec.querySelectorAll('.card'));
    let visibleCount = 0;
    cards.forEach(card=>{
      const titleOk = card.dataset.title.includes(query);
      let tagOk = true;
      if(activeFilter){
        const tags = (card.dataset.tags || '').toLowerCase();
        tagOk = tags.split(',').map(x=>x.trim()).filter(Boolean).includes(activeFilter.toLowerCase());
      }
      const show = titleOk && tagOk;
      card.style.display = show ? '' : 'none';
      if(show) visibleCount++;
    });
    sec.style.display = visibleCount > 0 ? '' : 'none';
  });
}

/* ========= sorting ========= */
function applySortAndReorder(){
  const sort = document.getElementById('sortSelect').value;
  const grid = document.getElementById('grid');
  let cards = Array.from(grid.children);
  if(sort === 'alpha'){
    cards = cards.sort((a,b)=>a.dataset.title.localeCompare(b.dataset.title));
  }
  grid.innerHTML = '';
  for(const card of cards) grid.appendChild(card);
  filterAndShowGrid();
}

/* ========= file loading and view initialization ========= */
function loadGames(device){
  fetch(FILES[device] + '?cacheBust=' + Date.now())
    .then(res=>res.text())
    .then(txt=>{
      const filters = extractFiltersFromTxt(txt);
      const categories = extractCategoriesFromTxt(txt);
      createCategoryTabs(categories);
      if(!filters || filters.length === 0) {
        const itemsTemp = (function(){ try{ return parseGamesTxt(txt); }catch(e){ return []; } })();
        const auto = new Set();
        itemsTemp.forEach(it => { if(it.tags && it.tags.length) it.tags.forEach(t=>auto.add(t)); });
        createFilterButtons(Array.from(auto));
      } else {
        createFilterButtons(filters);
      }
      const items = parseGamesTxt(txt);
      allItemsByDevice[device] = items;
      // render depending on current tab
      applyCurrentViewRender();
      // load slides for this device (to show owner slider if needed)
      if(isOwnerLoggedIn()) {
        loadSlidesForDevice(device);
      }
    })
    .catch(e=>{
      document.getElementById('grid').innerHTML = `<div style="color:#e74c3c;padding:20px;">Error loading list: ${escapeHtml(e.message)}</div>`;
    });
}

/* decide which view to render (All sections vs grid) */
function applyCurrentViewRender(){
  const active = getActiveTab();
  if(active === 'all'){
    document.getElementById('gridWrap').style.display='none';
    document.getElementById('allSections').style.display='';
    document.getElementById('requestSection').style.display='none';
    // render all sections from cache for current device
    renderAllSections(allItemsByDevice[currentDevice] || []);
    // show/hide owner slider
    if(isOwnerLoggedIn()){
      setupOwnerSlider();
    } else {
      hideOwnerSlider();
    }
  } else if(active === 'requests'){
    document.getElementById('gridWrap').style.display='none';
    document.getElementById('allSections').style.display='none';
    document.getElementById('requestSection').style.display='';
  } else {
    document.getElementById('allSections').style.display='none';
    document.getElementById('gridWrap').style.display='';
    renderGrid((allItemsByDevice[currentDevice] || []).filter(it => {
      // tab filter by category (also consider activeFilter later)
      return it.category.toLowerCase() === active.toLowerCase() || active.toLowerCase()==='all';
    }));
  }
}

/* helper: get active tab string */
function getActiveTab(){
  const active = document.querySelector('.tab.active');
  return (active && active.dataset && active.dataset.cat) ? active.dataset.cat : 'all';
}

/* ========= GitHub auth + Owner checks + Slides save/load ========= */
function isOwnerLoggedIn(){
  return githubUser && githubUser.login && (githubUser.login.toLowerCase() === 'lucyyuih'.toLowerCase());
}

function updateLoginUI(){
  if(githubUser){
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('loginSuccess').style.display = 'block';
    document.getElementById('githubUsername').textContent = githubUser.login;
    if(githubUser.avatar_url){
      document.getElementById('userAvatar').src = githubUser.avatar_url;
      document.getElementById('userAvatar').style.display = '';
      document.getElementById('defaultAvatar').style.display = 'none';
    }else{
      document.getElementById('userAvatar').style.display = 'none';
      document.getElementById('defaultAvatar').style.display = '';
    }
    document.getElementById('myRequestsViewTab').style.display = '';
  }else{
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('loginSuccess').style.display = 'none';
    document.getElementById('myRequestsViewTab').style.display = 'none';
  }
  document.getElementById('loginError').style.display = 'none';
  // Owner header
  document.getElementById('ownerHeaderArea').style.display = isOwnerLoggedIn() ? '' : 'none';
  // if owner and activeTab === all, show slider
  applyCurrentViewRender();
}

/* authenticate with GitHub user token (saves token in localStorage) */
async function authenticateWithGitHub(username, token){
  document.getElementById('loginSpinner').style.display = '';
  document.getElementById('githubLoginBtn').disabled = true;
  try{
    const res = await fetch('https://api.github.com/user', {
      headers: { Authorization: 'token ' + token }
    });
    if(!res.ok) throw new Error('Invalid token');
    githubUser = await res.json();
    githubToken = token;
    localStorage.setItem('github_token', token);
    localStorage.setItem('github_user', JSON.stringify(githubUser));
    updateLoginUI();
  }catch(e){
    showLoginError('GitHub authentication failed: ' + e.message);
  }
  document.getElementById('loginSpinner').style.display = 'none';
  document.getElementById('githubLoginBtn').disabled = false;
}

function showLoginError(msg){
  document.getElementById('loginError').textContent = msg;
  document.getElementById('loginError').style.display = 'block';
}

/* Build path for slides: slides_pc.txt / slides_android.txt
   Each file contains JSON: { items: [ "Game Title A", ... ], interval: 5 }
*/
function slidesPathFor(device){ return `slides_${device}.txt`; }

async function loadSlidesForDevice(device){
  // try to load from repo if token is available; if not, try localStorage
  const path = slidesPathFor(device);
  if(githubToken){
    try{
      const url = `https://api.github.com/repos/${REPO}/contents/${encodeURIComponent(path)}?t=${Date.now()}`;
      const res = await fetch(url, { headers: { Authorization: 'token ' + githubToken } });
      if(res.ok){
        const json = await res.json();
        const content = atob(json.content.replace(/\n/g,''));
        try{
          const parsed = JSON.parse(content);
          slidesData[device] = parsed;
        }catch(e){
          // if file is plain text (e.g. newline separated titles), convert
          const arr = content.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          slidesData[device] = { items: arr.slice(0,10), interval: 5 };
        }
        return;
      } else {
        // fallback to localStorage
        const local = localStorage.getItem(`slides_${device}`);
        if(local){
          slidesData[device] = JSON.parse(local);
        } else {
          slidesData[device] = { items: [], interval: 5 };
        }
      }
    }catch(e){
      const local = localStorage.getItem(`slides_${device}`);
      if(local){
        slidesData[device] = JSON.parse(local);
      } else {
        slidesData[device] = { items: [], interval: 5 };
      }
    }
  } else {
    // no token, use localStorage
    const local = localStorage.getItem(`slides_${device}`);
    if(local){
      slidesData[device] = JSON.parse(local);
    } else {
      slidesData[device] = { items: [], interval: 5 };
    }
  }
}

/* Save slides to repo (PUT contents) â€” if fails, save locally */
async function saveSlidesToRepo(device, data){
  const path = slidesPathFor(device);
  const url = `https://api.github.com/repos/${REPO}/contents/${encodeURIComponent(path)}`;
  const body = {
    message: `Update slides ${device}`,
    content: btoa(JSON.stringify(data, null, 2)),
    committer: {
      name: (githubUser && githubUser.login) ? githubUser.login : 'web-ui',
      email: (githubUser && githubUser.email) ? githubUser.email : 'noreply@example.com'
    }
  };
  try{
    // we need SHA if file already exists
    const getRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${encodeURIComponent(path)}`, {
      headers: { Authorization: 'token ' + githubToken }
    });
    if(getRes.ok){
      const j = await getRes.json();
      body.sha = j.sha;
    }
  }catch(e){ /* ignore */ }
  const res = await fetch(url, {
    method: 'PUT',
    headers: { Authorization: 'token ' + githubToken, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const err = await res.json().catch(()=>({message:'unknown'}));
    throw new Error(err.message || 'GitHub save failed');
  }
  return await res.json();
}

/* Save slides: try repo, otherwise save locally */
async function persistSlides(device, data){
  try{
    if(githubToken && isOwnerLoggedIn()){
      await saveSlidesToRepo(device, data);
      // success, update local cache and UI
      localStorage.setItem(`slides_${device}`, JSON.stringify(data));
      slidesData[device] = data;
      alert('Slides saved to repository successfully.');
      return true;
    } else {
      // save locally
      localStorage.setItem(`slides_${device}`, JSON.stringify(data));
      slidesData[device] = data;
      alert('Slides saved locally (token missing or no permissions).');
      return true;
    }
  }catch(e){
    // local fallback and notification
    localStorage.setItem(`slides_${device}`, JSON.stringify(data));
    slidesData[device] = data;
    alert('Could not save to repo: ' + e.message + ' â€” Saved to localStorage as fallback.');
    return false;
  }
}

/* ========= Owner slider (UI) - FIXED with proper image handling and arrow functionality ========= */
function setupOwnerSlider(){
  const wrap = document.getElementById('ownerSliderWrap');
  const slidesContainer = document.getElementById('slidesContainer');
  const dots = document.getElementById('sliderDots');
  const data = slidesData[currentDevice] || { items: [], interval: 5 };
  // get items by matching titles in parsed items
  const items = allItemsByDevice[currentDevice] || [];
  const matched = data.items.map(title=>{
    return items.find(it => it.title.toLowerCase() === title.toLowerCase());
  }).filter(Boolean);
  if(matched.length === 0){
    hideOwnerSlider();
    return;
  }
  // show slider
  wrap.style.display = '';
  slidesContainer.innerHTML = '';
  dots.innerHTML = '';
  matched.forEach((it, idx) => {
    const s = document.createElement('div'); 
    s.className='slide'; 
    if(idx===0) s.classList.add('active');
    s.dataset.index = idx;
    
    // Apply Caesar decoding to download URLs for slides too
    let decodedDownloadUrl = null;
    if(it.downloadUrl){
      try {
        decodedDownloadUrl = caesarDecodeLettersDigits(it.downloadUrl, 3);
        if(!/[A-Za-z][A-Za-z0-9+.\-]*:\/\//.test(decodedDownloadUrl) && /^[^\s]+\.[a-z]{2,}/i.test(decodedDownloadUrl)) {
          decodedDownloadUrl = 'http://' + decodedDownloadUrl;
        }
      } catch (e) {
        decodedDownloadUrl = it.downloadUrl;
      }
    }
    
    // Use imageUrl if available, otherwise use platform-specific fallback
    let thumbContent = 'No Image';
    if(it.imageUrl){
      thumbContent = `<img src="${it.imageUrl}" alt="">`;
    } else if(currentDevice==='pc' && it.pageUrl && it.pageUrl.includes('steampowered.com/app/')){
      const appIdMatch = it.pageUrl.match(/\/app\/(\d+)/);
      if(appIdMatch){
        const appId = appIdMatch[1];
        thumbContent = `<img src="https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/header.jpg" alt="">`;
      }
    } else if(currentDevice==='android' && it.pageUrl && it.pageUrl.includes('play.google.com/store/apps')){
      thumbContent = `<img src="https://play-lh.googleusercontent.com/ogw/AOLn63E8Koz5A9iVgX2WWv7jDrXw7W3wYw6iUP3Fa9fN=s32-c-mo" alt="">`;
    }
    
    s.innerHTML = `
      <div class="slide-inner">
        <div class="thumb">${thumbContent}</div>
        <div class="info">
          <div style="font-weight:800;font-size:20px;margin-bottom:8px">${escapeHtml(it.title)}</div>
          <div style="color:var(--muted);margin-bottom:10px">${escapeHtml(it.category)} Â· ${it.tags ? it.tags.join(', ') : ''}</div>
          <div style="display:flex;gap:8px">${decodedDownloadUrl ? `<a class="btn primary" href="${decodedDownloadUrl}" target="_blank">Download</a>` : ''}${it.pageUrl ? `<a class="btn ghost" href="${it.pageUrl}" target="_blank">Page</a>` : ''}</div>
        </div>
      </div>
    `;
    slidesContainer.appendChild(s);
    const d = document.createElement('div'); d.className='dot'; if(idx===0) d.classList.add('active');
    d.dataset.index = idx;
    d.onclick = () => { gotoSlide(idx); };
    dots.appendChild(d);
  });
  
  // FIXED: Properly set up slider controls
  const prevBtn = document.getElementById('prevSlideBtn');
  const nextBtn = document.getElementById('nextSlideBtn');
  
  // Remove existing event listeners to avoid duplicates
  prevBtn.replaceWith(prevBtn.cloneNode(true));
  nextBtn.replaceWith(nextBtn.cloneNode(true));
  
  // Get the new elements
  const newPrevBtn = document.getElementById('prevSlideBtn');
  const newNextBtn = document.getElementById('nextSlideBtn');
  
  // Add event listeners with proper functionality
  newPrevBtn.onclick = function() { 
    stopSliderTimer(); 
    prevSlide(); 
    startSliderTimer((slidesData[currentDevice]||{interval:5}).interval); 
  };
  
  newNextBtn.onclick = function() { 
    stopSliderTimer(); 
    nextSlide(); 
    startSliderTimer((slidesData[currentDevice]||{interval:5}).interval); 
  };
  
  // start timer
  currentSlideIndex = 0;
  startSliderTimer(data.interval || 5);
}

function hideOwnerSlider(){
  const wrap = document.getElementById('ownerSliderWrap');
  wrap.style.display = 'none';
  stopSliderTimer();
}

function startSliderTimer(intervalSec){
  stopSliderTimer();
  sliderTimer = setInterval(()=> { nextSlide(); }, (intervalSec||5)*1000);
}

function stopSliderTimer(){ 
  if(sliderTimer) { 
    clearInterval(sliderTimer); 
    sliderTimer = null; 
  } 
}

function gotoSlide(i){
  const slides = Array.from(document.querySelectorAll('.slide'));
  const dots = Array.from(document.querySelectorAll('.dot'));
  if(i < 0 || i >= slides.length) return;
  slides.forEach(s=>s.classList.remove('active'));
  dots.forEach(d=>d.classList.remove('active'));
  slides[i].classList.add('active');
  dots[i].classList.add('active');
  currentSlideIndex = i;
}

function nextSlide(){
  const slides = Array.from(document.querySelectorAll('.slide'));
  if(slides.length===0) return;
  const next = (currentSlideIndex + 1) % slides.length;
  gotoSlide(next);
}

function prevSlide(){
  const slides = Array.from(document.querySelectorAll('.slide'));
  if(slides.length===0) return;
  const prev = (currentSlideIndex - 1 + slides.length) % slides.length;
  gotoSlide(prev);
}

/* ========= Editor modal (owner-only) - FIXED with auto-update on device change ========= */
function openEditModal(device){
  // populate checkbox grid with games for that device
  const grid = document.getElementById('editorCheckboxGrid');
  grid.innerHTML = '';
  const games = allItemsByDevice[device] || [];
  const existing = (slidesData[device] && slidesData[device].items) ? slidesData[device].items.map(x=>x.toLowerCase()) : [];
  games.forEach((g, idx)=>{
    const id = `chk_${device}_${idx}`;
    const wrapper = document.createElement('label');
    wrapper.style.display='flex';
    wrapper.style.alignItems='center';
    wrapper.style.gap='8px';
    wrapper.style.padding='6px';
    wrapper.style.borderRadius='6px';
    wrapper.style.cursor='pointer';
    const cb = document.createElement('input');
    cb.type='checkbox'; cb.id = id; cb.dataset.title = g.title; cb.dataset.index = idx;
    if(existing.includes(g.title.toLowerCase())) cb.checked = true;
    cb.onchange = () => {
      enforceMaxSelection(device);
      updateSelectedCount(device);
    };
    const title = document.createElement('div');
    title.style.fontWeight='700'; title.style.fontSize='14px'; title.textContent = g.title;
    const small = document.createElement('div'); small.className='small-muted'; small.textContent = `${g.category} ${g.tags && g.tags.length ? 'Â· ' + g.tags.join(', '): ''}`;
    const right = document.createElement('div'); right.style.marginLeft='auto'; right.className='small-muted'; right.textContent = 'â†’';
    const left = document.createElement('div'); left.style.marginRight='8px'; left.className='small-muted';
    if(g.imageUrl) left.innerHTML = `<img src="${g.imageUrl}" alt="" style="width:44px;height:30px;object-fit:cover;border-radius:6px">`;
    wrapper.appendChild(cb);
    wrapper.appendChild(left);
    const texts = document.createElement('div'); texts.style.display='flex'; texts.style.flexDirection='column';
    texts.appendChild(title); texts.appendChild(small);
    wrapper.appendChild(texts);
    wrapper.appendChild(right);
    grid.appendChild(wrapper);
  });
  // interval
  document.getElementById('editorInterval').value = (slidesData[device] && slidesData[device].interval) ? slidesData[device].interval : 5;
  updateSelectedCount(device);
  document.getElementById('editorDeviceSelect').value = device;
  document.getElementById('editModal').style.display = '';
  document.getElementById('editorSearch').value = '';
  document.getElementById('editorSearch').oninput = function(){
    const q = this.value.toLowerCase();
    Array.from(document.getElementById('editorCheckboxGrid').children).forEach(label=>{
      const text = label.querySelector('div > div')?.textContent || label.textContent;
      label.style.display = text.toLowerCase().includes(q) ? '' : 'none';
    });
  };
}

function closeEditModal(){
  document.getElementById('editModal').style.display = 'none';
}

function updateSelectedCount(device){
  const checks = Array.from(document.querySelectorAll(`#editorCheckboxGrid input[type=checkbox]`));
  const selected = checks.filter(c=>c.checked).length;
  document.getElementById('selectedCount').textContent = `Selected: ${selected}/10`;
}

function enforceMaxSelection(device){
  const checks = Array.from(document.querySelectorAll(`#editorCheckboxGrid input[type=checkbox]`));
  const selected = checks.filter(c=>c.checked);
  if(selected.length > 10){
    // uncheck the last one
    const last = selected[selected.length - 1];
    last.checked = false;
    alert('You can only select up to 10 games.');
  }
}

async function saveSlidesFromEditor(){
  const device = document.getElementById('editorDeviceSelect').value;
  const interval = parseInt(document.getElementById('editorInterval').value) || 5;
  const checks = Array.from(document.querySelectorAll(`#editorCheckboxGrid input[type=checkbox]`));
  const selectedTitles = checks.filter(c=>c.checked).map(c=>c.dataset.title).slice(0,10);
  const data = { items: selectedTitles, interval };
  const ok = await persistSlides(device, data);
  if(ok){
    // reaplicar e fechar modal
    await loadSlidesForDevice(device);
    if(getActiveTab() === 'all' && isOwnerLoggedIn()){
      setupOwnerSlider();
    }
  }
}

/* ========= Requests / GitHub issues (kept functions) ========= */
const ISSUES_API = `https://api.github.com/repos/${REPO}/issues`;
function extractCategory(body){
  const m = body.match(/\*\*Category:\*\*\s*([^\n]+)/);
  return m ? m[1] : "N/A";
}
function extractLink(body){
  const m = body.match(/\*\*Link:\*\*\s*(https?:\/\/[^\s]+)/);
  return m ? m[1] : "#";
}
function extractDescription(body){
  return body.replace(/\*\*Category:.*\*\*Link:.*\n*/s,'').trim();
}
function makeRequestCard(issue){
  const el = document.createElement('div');
  el.className = 'request-card';
  const statusClass = issue.state === 'open' ? 'status-open' : 'status-closed';
  el.innerHTML = `
    <div class="request-title">${escapeHtml(issue.title)}</div>
    <div class="request-meta">
      <span class="request-category">${extractCategory(issue.body)}</span>
      <a class="request-link" href="${extractLink(issue.body)}" target="_blank">Link</a>
      <span>by <b>${escapeHtml(issue.user.login)}</b></span>
    </div>
    <div class="request-body">${escapeHtml(extractDescription(issue.body))}</div>
    <div class="request-status ${statusClass}">${issue.state.toUpperCase()}</div>
    <a href="${issue.html_url}" target="_blank" style="color:${issue.state==='open'?'#7c5cf7':'#e74c3c'};font-size:13px;">View on GitHub</a>
  `;
  return el;
}
async function loadRequests(view, status){
  const grid = document.getElementById('requestsGrid');
  grid.innerHTML = '<div style="color:#97a0ac;padding:20px;">Loading requests...</div>';
  let url = ISSUES_API + '?per_page=50&state=all';
  try{
    const res = await fetch(url);
    const issues = await res.json();
    let filtered = issues;
    if(status === 'open') filtered = issues.filter(i=>i.state==='open');
    if(status === 'closed') filtered = issues.filter(i=>i.state==='closed');
    if(view === 'my' && githubUser) filtered = filtered.filter(i=>i.user.login===githubUser.login);
    grid.innerHTML = '';
    for(const issue of filtered) grid.appendChild(makeRequestCard(issue));
    if(filtered.length === 0) grid.innerHTML = '<div style="color:#97a0ac;padding:20px;">No requests found.</div>';
  }catch(e){
    grid.innerHTML = '<div style="color:#e74c3c;padding:20px;">Error loading requests: '+e.message+'</div>';
  }
}
async function submitRequest(){
  if(!githubToken){
    showLoginError('You must be logged in to submit a request.');
    return;
  }
  const title = document.getElementById('requestTitle').value.trim();
  const category = document.getElementById('requestCategory').value.trim();
  const link = document.getElementById('requestLink').value.trim();
  const description = document.getElementById('requestDescription').value.trim();
  if(!title || !category || !link){
    showLoginError('Please fill in all required fields.');
    return;
  }
  const body = `**Category:** ${category}\n**Link:** ${link}\n\n${description}`;
  document.getElementById('submitRequest').disabled = true;
  try{
    const res = await fetch(ISSUES_API, {
      method: 'POST',
      headers: {
        Authorization: 'token ' + githubToken,
        Accept: 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({ title, body })
    });
    if(res.status === 201){
      document.getElementById('requestForm').reset();
      loadRequests();
      alert('Request submitted!');
    }else{
      const err = await res.json();
      showLoginError('Request failed: ' + (err.message || res.status));
    }
  }catch(e){
    showLoginError('Error submitting request: '+e.message);
  }
  document.getElementById('submitRequest').disabled = false;
}

/* ========= events and initialization ========= */
document.addEventListener('DOMContentLoaded', ()=> {
  // device buttons
  document.getElementById('btnPC').onclick = function(){
    if(currentDevice==='pc') return;
    currentDevice='pc';
    document.getElementById('btnPC').classList.add('active');
    document.getElementById('btnAndroid').classList.remove('active');
    activeFilter = null;
    loadGames('pc');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelector('.tab[data-cat="all"]').classList.add('active');
    updateUrlState('all', document.getElementById('sortSelect').value, 'pc');
  };
  document.getElementById('btnAndroid').onclick = function(){
    if(currentDevice==='android') return;
    currentDevice='android';
    document.getElementById('btnPC').classList.remove('active');
    document.getElementById('btnAndroid').classList.add('active');
    activeFilter = null;
    loadGames('android');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelector('.tab[data-cat="all"]').classList.add('active');
    updateUrlState('all', document.getElementById('sortSelect').value, 'android');
  };

  // delegation for tab clicks
  document.getElementById('tabGroup').onclick = function(e){
    const b = e.target.closest('.tab');
    if(!b || b.dataset.cat==='requests') return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    applyCurrentViewRender();
    updateUrlState(b.dataset.cat, document.getElementById('sortSelect').value, currentDevice);
  };

  document.getElementById('requestsTab').onclick = function(){
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    this.classList.add('active');
    applyCurrentViewRender();
    loadRequests();
    updateUrlState('requests','default',currentDevice);
  };

  document.getElementById('sortSelect').addEventListener('change', function(){
    applySortAndReorder();
    updateUrlState(getActiveTab(), this.value, currentDevice);
  });
  document.getElementById('search').addEventListener('input', function(){
    if(getActiveTab() === 'all') applySearchAndFilterAll();
    else filterAndShowGrid();
  });

  const zoomSlider = document.getElementById('zoomSlider');
  const colsCount = document.getElementById('colsCount');
  if (zoomSlider) {
    zoomSlider.addEventListener('input', e => {
      applyColumns(e.target.value);
      colsCount.textContent = e.target.value;
    });
    const savedCols = parseInt(localStorage.getItem('gridColumns') || getComputedStyle(document.documentElement).getPropertyValue('--cols') || 5, 10);
    zoomSlider.value = Math.min(8, Math.max(1, savedCols));
    colsCount.textContent = zoomSlider.value;
    applyColumns(zoomSlider.value);
  }
  const optionsBtn = document.getElementById('optionsBtn');
  const optionsMenu = document.getElementById('optionsMenu');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', ()=> {
      const isVisible = optionsMenu.classList.contains('show');
      if (isVisible) {
        optionsMenu.classList.remove('show');
        optionsMenu.setAttribute('aria-hidden', 'true');
      } else {
        optionsMenu.classList.add('show');
        optionsMenu.setAttribute('aria-hidden', 'false');
      }
    });
  }
  document.addEventListener('click', (e) => {
    if (optionsMenu && !optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
      optionsMenu.classList.remove('show');
      optionsMenu.setAttribute('aria-hidden', 'true');
    }
  });

  // requests
  document.getElementById('submitRequest').addEventListener('click', submitRequest);
  document.getElementById('githubLoginBtn').addEventListener('click', async () => {
    const username = document.getElementById('githubUsernameInput').value.trim();
    const token = document.getElementById('githubTokenInput').value.trim();
    if (!username || !token) {
      showLoginError('Enter username and token');
      return;
    }
    await authenticateWithGitHub(username, token);
    // if owner, show owner header and load slides for device
    if(isOwnerLoggedIn()){
      document.getElementById('ownerHeaderArea').style.display = '';
      await loadSlidesForDevice(currentDevice);
      applyCurrentViewRender();
    }
  });
  document.getElementById('githubLogoutBtn').addEventListener('click', () => {
    githubToken = null;
    githubUser = null;
    localStorage.removeItem('github_token');
    localStorage.removeItem('github_user');
    updateLoginUI();
    document.getElementById('myRequestsViewTab').style.display = 'none';
    loadRequests();
  });
  document.getElementById('allRequestsViewTab').addEventListener('click', () => loadRequests('all'));
  document.getElementById('myRequestsViewTab').addEventListener('click', () => loadRequests('my'));
  document.getElementById('openRequestsTab').addEventListener('click', () => loadRequests(null,'open'));
  document.getElementById('closedRequestsTab').addEventListener('click', () => loadRequests(null,'closed'));

  // editor modal - FIXED: Now properly opens the modal and updates when device changes
  document.getElementById('openEditorBtn').addEventListener('click', () => {
    if(!isOwnerLoggedIn()){ alert('Only the owner can edit'); return; }
    document.getElementById('editorDeviceSelect').value = currentDevice;
    openEditModal(currentDevice);
  });
  
  // FIXED: Add event listener for device change in editor
  document.getElementById('editorDeviceSelect').addEventListener('change', function() {
    const device = this.value;
    openEditModal(device);
  });
  
  document.getElementById('closeEditorBtn').addEventListener('click', closeEditModal);
  document.getElementById('saveSlidesBtn').addEventListener('click', saveSlidesFromEditor);
  document.getElementById('clearSlidesBtn').addEventListener('click', async ()=>{
    const dev = document.getElementById('editorDeviceSelect').value;
    if(!confirm('Clear selection for ' + dev + '?')) return;
    slidesData[dev] = { items: [], interval: 5 };
    await persistSlides(dev, slidesData[dev]);
    openEditModal(dev);
  });
  document.getElementById('saveLocalBtn').addEventListener('click', async ()=>{
    const dev = document.getElementById('editorDeviceSelect').value;
    const interval = parseInt(document.getElementById('editorInterval').value) || 5;
    const checks = Array.from(document.querySelectorAll(`#editorCheckboxGrid input[type=checkbox]`));
    const selectedTitles = checks.filter(c=>c.checked).map(c=>c.dataset.title).slice(0,10);
    const data = { items: selectedTitles, interval };
    localStorage.setItem(`slides_${dev}`, JSON.stringify(data));
    slidesData[dev] = data;
    alert('Saved locally.');
  });

  // FIXED: Slider arrow buttons now work properly
  // These event listeners are now set up in setupOwnerSlider() to avoid duplicate handlers

  // load saved token/user
  const savedToken = localStorage.getItem('github_token');
  const savedUser = localStorage.getItem('github_user');
  if(savedToken && savedUser){
    githubToken = savedToken;
    try{ githubUser = JSON.parse(savedUser); }catch(e){}
    updateLoginUI();
  }

  // initial state
  const urlState = readStateFromLocation();
  if(urlState.device && (urlState.device==='pc'||urlState.device==='android')) currentDevice = urlState.device;
  document.getElementById('btnPC').classList.toggle('active', currentDevice==='pc');
  document.getElementById('btnAndroid').classList.toggle('active', currentDevice==='android');
  loadGames(currentDevice);

  window.addEventListener('hashchange', () => { try { restoreStateFromLocation(); } catch(e){} });
  window.addEventListener('popstate', () => { try { restoreStateFromLocation(); } catch(e){} });
});

/* ========= URL routing helpers ========= */
function buildStatePath(tab, sort, device) {
  device = (device || 'pc').toLowerCase();
  tab = (tab || 'all').toString().toLowerCase();
  sort = (sort || 'default').toString().toLowerCase();
  if (tab === 'requests') {
    return `/${encodeURIComponent(device)}/${encodeURIComponent(tab)}`;
  }
  if (!sort || sort === 'default') {
    return `/${encodeURIComponent(device)}/${encodeURIComponent(tab)}`;
  }
  return `/${encodeURIComponent(device)}/${encodeURIComponent(tab)}/${encodeURIComponent(sort)}`;
}
function parseStateFromHash(hash) {
  if (!hash) return null;
  const cleaned = hash.replace(/^#(!)?/, '');
  if (!cleaned) return null;
  const parts = cleaned.replace(/^\/+|\/+$/g,'').split('/');
  const device = (parts[0] || 'pc').toLowerCase();
  const tab = (parts[1] || 'all').toLowerCase();
  const sort = (parts[2] || 'default').toLowerCase();
  return { device, tab, sort };
}
function parseStateFromPathname(path) {
  if (!path) return null;
  const p = path.split('?')[0].split('#')[0];
  const clean = p.replace(/^\/+|\/+$/g,'');
  if (!clean) return { device: 'pc', tab: 'all', sort: 'default' };
  const parts = clean.split('/');
  const device = (parts[0] || 'pc').toLowerCase();
  const tab = (parts[1] || 'all').toLowerCase();
  const sort = (parts[2] || 'default').toLowerCase();
  return { device, tab, sort };
}
function readStateFromLocation() {
  const fromHash = parseStateFromHash(location.hash);
  if (fromHash) return fromHash;
  const fromPath = parseStateFromPathname(location.pathname);
  if (fromPath) return fromPath;
  return { device: 'pc', tab: 'all', sort: 'default' };
}
function updateUrlState(tab, sort, device) {
  device = (device || 'pc').toLowerCase();
  tab = (tab || 'all').toString().toLowerCase();
  sort = (sort || 'default').toString().toLowerCase();
  const useHashRouting = (function(){
    try {
      if (location.protocol === 'file:') return true;
      const host = (location.hostname || '').toLowerCase();
      if (host.includes('github.io')) return true;
    } catch(e){}
    return false;
  })();
  try {
    const path = buildStatePath(tab, sort, device);
    if (useHashRouting) {
      const hash = '#' + path;
      if (location.hash !== hash) {
        history.replaceState(null, '', location.pathname + hash);
      }
    } else {
      const newUrl = path;
      if (location.pathname !== newUrl || location.search !== '') {
        history.replaceState(null, '', newUrl + location.search + location.hash);
      }
    }
  } catch (e) {
    console.warn('updateUrlState failed', e);
  }
}
function restoreStateFromLocation(){
  const state = readStateFromLocation();
  if (state.device && (state.device === 'pc' || state.device === 'android') && state.device !== currentDevice) {
    currentDevice = state.device;
    document.getElementById('btnPC').classList.toggle('active', currentDevice==='pc');
    document.getElementById('btnAndroid').classList.toggle('active', currentDevice==='android');
    loadGames(currentDevice);
  }
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  let foundTab = null;
  document.querySelectorAll('.tab').forEach(tabEl=>{
    if(tabEl.dataset.cat && tabEl.dataset.cat.toLowerCase() === state.tab) {
      foundTab = tabEl;
    }
  });
  if(foundTab) foundTab.classList.add('active');
  else {
    const fallback = document.querySelector('.tab[data-cat="all"]');
    if(fallback) fallback.classList.add('active');
  }
  if(state.tab === 'requests'){
    document.getElementById('gridWrap').style.display = 'none';
    document.getElementById('requestSection').style.display = 'block';
    document.getElementById('allSections').style.display = 'none';
  }else if(state.tab === 'all'){
    document.getElementById('gridWrap').style.display = 'none';
    document.getElementById('allSections').style.display = '';
    document.getElementById('requestSection').style.display = 'none';
  }else{
    document.getElementById('gridWrap').style.display = '';
    document.getElementById('allSections').style.display = 'none';
    document.getElementById('requestSection').style.display = 'none';
  }
  if(document.getElementById('sortSelect')){
    document.getElementById('sortSelect').value = state.sort || 'default';
    applySortAndReorder();
  }
  applyCurrentViewRender();
}
</script>
</body>
</html>