<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Games that fell off the truck</title>
<style>
:root{
  --bg:#0b0f14;
  --muted:#97a0ac;
  --accent:#7c5cf7;
  --glass: rgba(255,255,255,0.03);
  --radius:14px;
  --gap:18px;
  --cols: 3;
  --card-scale: 1;
  --title-size: calc(15px * var(--card-scale));
  --meta-size: calc(12px * var(--card-scale));
  --btn-font: calc(13px * var(--card-scale));
  --btn-padding-vert: calc(8px * var(--card-scale));
  --btn-padding-horiz: calc(10px * var(--card-scale));
  --thumb-aspect: 16 / 9;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#07090c 0%, #0b0f14 100%);color:#e6eef8;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto,Arial;overflow-x:hidden;}
.app{max-width:1200px;margin:28px auto;padding:20px;}
header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
.brand{display:flex;gap:12px;align-items:center;}
.square{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#4bb6ff);font-weight:800;color:#06111a;font-size:22px;font-family:sans-serif;}
.titleWrap{display:flex;flex-direction:column;}
.titleWrap h1{font-size:18px;margin:0}
.titleWrap .lead{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.search{background:var(--glass);padding:10px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;min-width:160px;max-width:420px;}
.search input{background:transparent;border:0;color:inherit;outline:none;font-size:14px;width:100%;min-width:0;}
.sort-wrap{display:flex;align-items:center;gap:8px;margin-left:8px}
.sort-select{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:inherit;font-weight:600}
.options-container { position: relative; margin-left: auto; }
.options-menu { display: none; position: absolute; top: 110%; right: 0; background: var(--glass); backdrop-filter: blur(8px); border-radius: 10px; padding: 12px; min-width: 160px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);}
.options-menu.show { display: flex; align-items: center; gap: 12px; }
.options-menu input[type=range]{ -webkit-appearance: none; appearance: none; width:140px; height:8px; background: linear-gradient(90deg,#2b3340,#111418); border-radius:6px; outline:none; }
.options-menu input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:20px;height:20px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#4bb6ff);box-shadow:0 6px 18px rgba(124,92,247,0.18); }
.options-menu input[type=range]::-moz-range-thumb{ width:20px;height:20px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#4bb6ff);border:0; }
.cols-count{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px; font-weight:800; color:#eaf2ff; min-width:38px; text-align:center; font-size:13px;}
.device-filters{display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap;align-items:center;}
.device-btn{padding:8px 18px;border-radius:999px;cursor:pointer;font-weight:700;font-size:14px;border:1px solid rgba(255,255,255,0.08);background:var(--glass);color:var(--muted);}
.device-btn.active{background:linear-gradient(90deg,#4bb6ff,#7c5cf7);color:#06111a;border:0;}
.dynamic-filters { display:flex; gap:8px; align-items:center; margin-left: 8px; flex-wrap:wrap; }
.filter-btn { padding: 6px 12px; border-radius: 999px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.04); color: var(--muted); cursor: pointer; font-weight:700;}
.filter-btn.active { background: linear-gradient(90deg,#4bb6ff,#7c5cf7); color: #06111a; border:0; }
.tabs{display:flex;gap:8px;padding:12px 0;margin-bottom:12px;align-items:center;flex-wrap:wrap;}
.tab-group{display:flex;gap:8px;flex:1;align-items:center;flex-wrap:wrap;}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:600;font-size:13px;}
.tab.active{background:linear-gradient(90deg, rgba(124,92,247,0.12), rgba(75,182,255,0.06));border-color:transparent;color:#e9f0ff;box-shadow:0 6px 20px rgba(16,18,22,0.4)}
.tab.requests-tab{margin-left:auto;background:linear-gradient(90deg,#4bb6ff,#7c5cf7);color:#06111a;border:0;box-shadow:0 8px 30px rgba(75,182,255,0.12);}
.grid{display:grid;gap:var(--gap);grid-template-columns: repeat(var(--cols), minmax(0, 1fr));align-items:start;overflow:auto;padding-bottom:6px;transition:all 0.18s ease;width:100%;}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:calc(12px * var(--card-scale));border-radius:var(--radius);display:flex;flex-direction:column;gap:calc(10px * var(--card-scale));border:1px solid rgba(255,255,255,0.03);transition:transform 0.18s ease;}
.thumb{border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:linear-gradient(135deg,#07101a,#0b1420);box-shadow:inset 0 -20px 40px rgba(0,0,0,0.35);aspect-ratio: var(--thumb-aspect);width:100%;min-height:60px;}
.thumb img{width:100%;height:100%;object-fit:cover;display:block;transition: opacity 0.25s ease;}
.card .title{font-size:var(--title-size);margin:0;color:#eaf2ff;font-weight:700;line-height:1.15}
.card .meta{font-size:var(--meta-size);color:var(--muted);display:block;margin-top:-2px}
.btn{flex:0 0 auto;padding:8px 10px;border-radius:10px;border:0;background:transparent;color:#cfe3ff;font-weight:700;font-size:13px;cursor:pointer;border:1px solid rgba(255,255,255,0.04);text-decoration:none;display:inline-flex;align-items:center;justify-content:center;min-height:32px;}
.card .btn{flex:1 1 0;padding: var(--btn-padding-vert) var(--btn-padding-horiz);font-size: var(--btn-font);min-height: calc(32px * var(--card-scale));min-width: 0;}
.btn.primary{background:linear-gradient(90deg,var(--accent),#4bb6ff);color:#06111a;box-shadow:0 8px 30px rgba(124,92,247,0.12);border:0}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
.btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
.extra-buttons{display:flex;gap:6px;flex-wrap:wrap;flex:1 1 100%}
.card .buttons { display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%; }
.request-form { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03)); border-radius: var(--radius); padding: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px;}
.form-group { margin-bottom: 16px; }
.form-control { width:100%; padding:10px 12px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:10px; color:#eaf2ff; }
.requests-grid { display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
.request-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding: 16px; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.03); position: relative;}
.request-title{font-size:16px;margin:8px 0;font-weight:700;color:#eaf2ff"}
.request-meta { color: var(--muted); font-size:13px; margin-bottom: 10px; display:flex; gap:12px; align-items:center; }
.request-category { display:inline-block; padding:4px 10px; background: rgba(124,92,247,0.1); border-radius:6px; color:#c6b3ff; font-weight:700; font-size:13px;}
.request-body{font-size:14px;color:#d0d8e3;line-height:1.4;margin-bottom:8px}
.request-status { position:absolute; top:16px; right:16px; font-size:11px; padding:6px 8px; border-radius:6px; font-weight:700; }
.status-open { background: rgba(46, 204, 113, 0.12); color: #2ecc71; border:1px solid rgba(46,204,113,0.08) }
.status-closed { background: rgba(231, 76, 60, 0.12); color: #e74c3c; border:1px solid rgba(231,76,60,0.08) }
.request-link { color: #7c5cf7; text-decoration:none; font-weight:700 }
.footer{color:var(--muted);font-size:12px;margin-top:14px;text-align:center}
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="square">üéÆ</div>
        <div class="titleWrap">
          <h1>Games that fell off the truck</h1>
          <div class="lead">Games rescued from the wild</div>
        </div>
      </div>
      <div class="controls">
        <div style="display:flex;align-items:center">
          <div class="search" title="Search by name">
            üîé <input id="search" placeholder="Search by name..." />
          </div>
          <div class="sort-wrap">
            <label for="sortSelect" style="font-size:13px;color: var(--muted)">Sort:</label>
            <select id="sortSelect" class="sort-select" title="Sort games">
              <option value="default">Default</option>
              <option value="alpha">Alphabetical</option>
              <option value="recent">Most Recent Added</option>
            </select>
          </div>
        </div>
        <div class="options-container">
          <button id="optionsBtn" class="btn ghost" type="button">‚öô Options</button>
          <div id="optionsMenu" class="options-menu" aria-hidden="true">
            <input type="range" id="zoomSlider" min="1" max="8" step="1" />
            <div class="cols-count" id="colsCount">3</div>
          </div>
        </div>
      </div>
    </header>

    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
      <div class="device-filters" id="deviceFilters">
        <button class="device-btn active" data-device="pc" id="btnPC">PC</button>
        <button class="device-btn" data-device="android" id="btnAndroid">Android</button>
      </div>
      <!-- container onde os filtros do TXT ser√£o criados dinamicamente -->
      <div class="dynamic-filters" id="dynamicFilters" aria-live="polite"></div>
    </div>

    <nav class="tabs" id="tabs">
      <div class="tab-group" id="tabGroup">
        <button class="tab active" data-cat="all" type="button">All</button>
        <button class="tab" data-cat="Indie" type="button">Indie</button>
        <button class="tab" data-cat="AAA" type="button">AAA</button>
        <button class="tab" data-cat="NSFW" type="button">NSFW</button>
      </div>
      <button class="tab requests-tab" data-cat="requests" id="requestsTab" type="button">Requests</button>
    </nav>

    <main>
      <section id="grid" class="grid" aria-live="polite"></section>
      <section id="requestSection" style="display: none;">
        <!-- request form (mantido como antes) -->
        <form class="request-form" id="requestForm" novalidate>
          <h2>Request a Game</h2>
          <p style="margin-bottom: 16px; color: var(--muted);">Submit your request for a new game to be added to the collection (requires GitHub login).</p>
          <div id="githubLoginSection" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
            <div id="loginForm" style="display: block;">
              <h3 style="margin: 0 0 12px 0; color: #eaf2ff; font-size: 16px;">GitHub Authentication</h3>
              <p style="margin: 0 0 16px 0; color: var(--muted); font-size: 14px;">Login with your GitHub Personal Access Token to submit and manage requests</p>
              <div class="form-group" style="margin-bottom: 12px;">
                <label for="githubUsername" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">GitHub Username*</label>
                <input type="text" id="githubUsernameInput" class="form-control" placeholder="your-github-username" required>
              </div>
              <div class="form-group" style="margin-bottom: 16px;">
                <label for="githubToken" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">Personal Access Token*</label>
                <input type="password" id="githubTokenInput" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                <small style="display: block; margin-top: 4px; color: var(--muted); font-size: 12px;">
                  <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--accent); text-decoration: none;">Create a token</a> with 'repo' and 'user' scopes
                </small>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button id="githubLoginBtn" class="btn primary" type="button">Login</button>
                <div id="loginSpinner" style="display: none;">
                  <div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
              </div>
              <div id="loginError" style="display: none; margin-top: 12px; padding: 10px; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.2); border-radius: 6px; color: #e74c3c;"></div>
            </div>
            <div id="loginSuccess" style="display: none;">
              <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <img id="userAvatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; display: none;">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center;" id="defaultAvatar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  </div>
                  <div>
                    <p style="margin: 0; color: #2ecc71; font-weight: 700; font-size: 14px;">Logged in as <span id="githubUsername"></span></p>
                    <p style="margin: 0; color: var(--muted); font-size: 12px;">You can now submit and manage requests</p>
                  </div>
                </div>
                <button id="githubLogoutBtn" class="btn ghost small" type="button">Logout</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="requestTitle">Title*</label>
            <input type="text" id="requestTitle" class="form-control" placeholder="Name of the game, etc." required>
          </div>
          <div class="form-group">
            <label for="requestCategory">Category*</label>
            <select id="requestCategory" class="form-control" required>
              <option value="">Select a category</option>
              <option value="Indie">Indie</option>
              <option value="AAA">AAA</option>
              <option value="NSFW">NSFW</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="requestLink">Link*</label>
            <input type="url" id="requestLink" class="form-control" placeholder="https://store.steampowered.com/app/..." required>
            <small style="display: block; margin-top: 4px; color: var(--muted);">Where can we find this game?</small>
          </div>
          <div class="form-group">
            <label for="requestDescription">Description</label>
            <textarea id="requestDescription" class="form-control" rows="4" placeholder="Provide any additional details..."></textarea>
          </div>
          <div class="form-actions" style="display:flex;gap:8px;align-items:center;">
            <button id="submitRequest" class="btn primary" type="button">Submit Request</button>
            <a href="https://github.com/LucyYuih/Games-that-fell-off-the-truck/issues" target="_blank" class="btn ghost">View All Requests</a>
          </div>
        </form>

        <div class="request-divider" style="height:18px;"></div>
        <h2>Requests</h2>
        <div class="request-view-tabs" style="display: flex; gap: 8px; margin: 12px 0;">
          <button class="request-view-tab active" id="allRequestsViewTab" type="button">All Requests</button>
          <button class="request-view-tab" id="myRequestsViewTab" style="display: none;" type="button">My Requests</button>
        </div>
        <div class="request-tabs" role="tablist" aria-label="Request status tabs" style="margin-bottom:12px;">
          <button class="request-tab active" id="openRequestsTab" type="button">Open</button>
          <button class="request-tab" id="closedRequestsTab" type="button">Closed</button>
        </div>
        <p id="requestsDescription" style="margin-bottom: 16px; color: var(--muted);">Recent requests from the community.</p>
        <div class="requests-grid" id="requestsGrid"></div>
      </section>
    </main>
    <div class="footer">@LucyYuih</div>
  </div>

<script>
/*
  Vers√£o robusta para detectar categorias corretamente tanto em Android quanto em PC.
  Melhorias chave:
  - isUrlLine: mais robusto e case-insensitive
  - isCategoryCandidate: regras estritas para aceitar uma linha como categoria
  - apply isCategoryCandidate tanto em extractCategoriesFromTxt quanto em parseGamesTxt
  Todas as demais funcionalidades foram mantidas.
*/

// URLs dos arquivos de texto (mantive como antes)
const FILES = {
  pc: 'https://raw.githubusercontent.com/LucyYuih/Games-that-fell-off-the-truck/main/games.txt',
  android: 'https://raw.githubusercontent.com/LucyYuih/Games-that-fell-off-the-truck/main/gamesandroid.txt'
};
let currentDevice = 'pc';
let activeFilter = null; // filtro ativo vindo dos bot√µes din√¢micos

// fun√ß√£o para decodificar C√©sar (letras + d√≠gitos) shift=3 (usada no bot√£o Download)
function caesarDecodeLettersDigits(text, shift) {
  const sLetters = ((shift % 26) + 26) % 26;
  const sDigits = ((shift % 10) + 10) % 10;
  let out = '';
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const code = ch.charCodeAt(0);
    if (code >= 97 && code <= 122) {
      const base = 97;
      const dec = (code - base - sLetters + 26) % 26 + base;
      out += String.fromCharCode(dec);
    } else if (code >= 65 && code <= 90) {
      const base = 65;
      const dec = (code - base - sLetters + 26) % 26 + base;
      out += String.fromCharCode(dec);
    } else if (code >= 48 && code <= 57) {
      const base = 48;
      const dec = (code - base - sDigits + 10) % 10 + base;
      out += String.fromCharCode(dec);
    } else {
      out += ch;
    }
  }
  return out;
}

// ========= Utilit√°rios aprimorados para detec√ß√£o de URL / categoria =========
function isUrlLine(s){
  if(!s) return false;
  const t = s.trim();
  // se cont√©m :// (qualquer caixa), √© URL
  if(/:\/\//i.test(t)) return true;
  // se come√ßar com www. ou http(s) (case-insensitive)
  if(/^\s*www\./i.test(t)) return true;
  if(/^\s*https?:\/\//i.test(t)) return true;
  // se cont√©m dom√≠nio-like com TLD (.com, .io, .net etc.) seguido de barra ou fim
  if(/[^\s\/]+\.(?:com|net|org|io|gg|app|store|dev|co|br|ru|de|jp|fr|uk|edu)(\/|$)/i.test(t)) return true;
  // se cont√©m espa√ßos n√£o, mas cont√©m slash / e ponto . typical path -> url-like
  if(/\.[a-z]{2,6}\/?/i.test(t) && /\/+/.test(t)) return true;
  return false;
}

// Decide se uma linha √© candidata a categoria (regras estritas)
function isCategoryCandidate(s){
  if(!s) return false;
  const t = s.trim();
  if(t.length === 0) return false;
  if(t.length > 70) return false; // muito longa para ser categoria
  // rejeita se for claramente URL-like
  if(isUrlLine(t)) return false;
  // rejeita se contiver caracteres comuns em URLs (':', '/', '?', '=', '&')
  if(/[:\/\?=&]/.test(t)) return false;
  // permitir letras, n√∫meros, espa√ßos e alguns sinais de pontua√ß√£o t√≠picos de t√≠tulos
  // aceita: letras (unicode), n√∫meros, espa√ßos, ap√≥strofo, h√≠fen, par√™ntese, v√≠rgula, ponto, &:.
  // rejeita linhas que s√£o apenas siglas estranhas (mas permitiremos siglas curtas)
  if(!/^[\p{L}\p{N}\s\-'.,()&:!]+$/u.test(t)) return false;
  // rejeita strings que s√£o puramente n√∫meros
  if(/^[0-9]+$/.test(t)) return false;
  // OK
  return true;
}

// ========= Fun√ß√£o que extrai filtros globais do texto (linhas do tipo "filters: a, b, c") =========
function extractFiltersFromTxt(txt) {
  const lines = txt.split(/\r?\n/);
  const filtersSet = new Set();
  for (let raw of lines) {
    const line = raw.replace(/\u00A0/g,' ').trim();
    if (!line) continue;
    // identificadores aceitos: filters:, filtros:, tags:, categories:
    const m = line.match(/^(filters?|filtros|tags?|categories?)\s*[:\-]\s*(.+)$/i);
    if (m) {
      const list = m[2].split(',').map(x => x.trim()).filter(Boolean);
      for (const it of list) filtersSet.add(it);
    }
  }
  return Array.from(filtersSet);
}

// ========= Nova fun√ß√£o: extrair categorias do TXT (mantendo ordem e incluindo vazias) =========
function extractCategoriesFromTxt(txt) {
  const lines = txt.split(/\r?\n/);
  const cats = [];
  function addCat(name){
    if(!name) return;
    const nm = name.trim();
    if(!nm) return;
    if(!cats.includes(nm)) cats.push(nm);
  }
  // percorre e detecta poss√≠veis cabe√ßalhos de categoria (aplicando heur√≠stica mais segura)
  for(let i=0;i<lines.length;i++){
    const raw = (lines[i] || '').replace(/\u00A0/g,' ').trim();
    if(!raw) continue;
    if(/^[-]{3,}$/.test(raw)) continue; // separator
    const lower = raw.toLowerCase();
    if(lower.startsWith('image') || lower.startsWith('original') || lower.startsWith('filters') || lower.startsWith('tags')) continue;
    // peek next non-empty and nextNext
    let j=i+1; while(j<lines.length && (!lines[j] || !lines[j].trim())) j++;
    let next = (j<lines.length) ? (lines[j] || '').replace(/\u00A0/g,' ').trim() : null;
    let k=j+1; while(k<lines.length && (!lines[k] || !lines[k].trim())) k++;
    let nextNext = (k<lines.length) ? (lines[k] || '').replace(/\u00A0/g,' ').trim() : null;
    // Heur√≠stica segura:
    // Se raw √© candidato a categoria (isCategoryCandidate) e:
    //  - nextNext √© URL (ent√£o next √© t√≠tulo) OR
    //  - previous or next is --- OR
    //  - next exists and next is a title-like line (not URL) but raw is category candidate
    // Em resumo: s√≥ considera raw como categoria SE raw passar isCategoryCandidate
    if(!isCategoryCandidate(raw)) continue;
    if(nextNext && isUrlLine(nextNext)) { addCat(capitalize(raw)); continue; }
    // prev non-empty
    let prevIndex=i-1; while(prevIndex>=0 && (!lines[prevIndex] || !lines[prevIndex].trim())) prevIndex--;
    let prev = (prevIndex>=0) ? (lines[prevIndex]||'').replace(/\u00A0/g,' ').trim() : null;
    if(prev && /^[-]{3,}$/.test(prev)) { addCat(capitalize(raw)); continue; }
    if(next && /^[-]{3,}$/.test(next)) { addCat(capitalize(raw)); continue; }
    // if next exists and is not URL and raw is category candidate, treat raw as category
    if(next && !isUrlLine(next)) { addCat(capitalize(raw)); continue; }
  }
  if(cats.length === 0) {
    ['Indie','AAA','NSFW'].forEach(c=>{ if(!cats.includes(c)) cats.push(c); });
  }
  return cats;
}

// ========== Utilit√°rios (escape, capitalize) =========
function escapeHtml(s){
  return String(s).replace(/[&<>"'`]/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m];
  });
}
function capitalize(s){ return s && s.length ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

// ========= Parser principal (melhorado) =========
function parseGamesTxt(txt){
  const lines = txt.split(/\r?\n/);
  let currentCategory = null;
  const items = [];
  let block = [];
  function flushBlock(){
    if(block.length===0) return;
    let item = parseBlock(block, currentCategory);
    if(item) items.push(item);
    block=[];
  }
  for(let i=0;i<lines.length;i++){
    const rawLine = lines[i] || '';
    const line = rawLine.replace(/\u00A0/g,' ').trim();
    if(!line){
      flushBlock();
      continue;
    }
    if(line.startsWith('#')) continue;
    const lower = line.toLowerCase();
    if(/^[-]{3,}$/.test(line)) { flushBlock(); continue; }

    // Heur√≠stica aprimorada para detectar cabe√ßalhos de categoria (mais segura):
    // S√≥ aceita se isCategoryCandidate(raw) === true
    if(!lower.startsWith('image') && !lower.startsWith('original') && !lower.startsWith('filters') && !lower.startsWith('tags')){
      // prev/next detection
      let j=i+1; while(j<lines.length && (!lines[j] || !lines[j].trim())) j++;
      let next = (j<lines.length) ? (lines[j] || '').replace(/\u00A0/g,' ').trim() : null;
      let k=j+1; while(k<lines.length && (!lines[k] || !lines[k].trim())) k++;
      let nextNext = (k<lines.length) ? (lines[k] || '').replace(/\u00A0/g,' ').trim() : null;
      // prev non-empty
      let p = i-1; while(p>=0 && (!lines[p] || !lines[p].trim())) p--;
      let prev = (p>=0) ? (lines[p] || '').replace(/\u00A0/g,' ').trim() : null;

      if(isCategoryCandidate(line)){
        if(nextNext && isUrlLine(nextNext) && !isUrlLine(line)){
          flushBlock();
          currentCategory = capitalize(line);
          continue;
        }
        if(prev && /^[-]{3,}$/.test(prev)) { flushBlock(); currentCategory = capitalize(line); continue; }
        if(next && /^[-]{3,}$/.test(next)) { flushBlock(); currentCategory = capitalize(line); continue; }
        if(next && !isUrlLine(next)) {
          flushBlock();
          currentCategory = capitalize(line);
          continue;
        }
      }
    }

    // otherwise accumulate as block
    block.push(line);
  }
  flushBlock();
  return items;
}

function parseBlock(blockLines, currentCategory){
  if(blockLines.length === 0) return null;
  const lines = blockLines.filter(l => l && l.trim() !== '');
  const title = lines[0].trim();
  let downloadUrl = null, pageUrl = null, imageUrl = null;
  let gotOriginal = false;
  const urls = [];
  const tags = []; // tags locais do bloco
  // detecta QUALQUER esquema tipo xxx://...
  const extractUrls = (str) => {
    const m = str.match(/[A-Za-z][A-Za-z0-9+.\-]*:\/\/[^\s)]+/g);
    return m || [];
  };
  for(let i=1;i<lines.length;i++){
    const ln = lines[i].trim();
    // linha de imagem expl√≠cita (mantive)
    const imageLineMatch = ln.match(/^\s*image\s*[:\-]?\s*(https?:\/\/[^\s)]+)\s*$/i);
    if(imageLineMatch){
      imageUrl = imageLineMatch[1];
      continue;
    }
    if(ln.toLowerCase() === 'original'){ gotOriginal = true; continue; }
    // detecta tags locais do bloco: filters: a, b  ou tags: a,b
    const tagMatch = ln.match(/^(filters?|filtros|tags?)\s*[:\-]\s*(.+)$/i);
    if(tagMatch){
      // junta as tags locais
      const local = tagMatch[2].split(',').map(x=>x.trim()).filter(Boolean);
      for(const t of local) if(!tags.includes(t)) tags.push(t);
      continue;
    }
    const found = extractUrls(ln);
    if(found.length){
      for(const u of found) urls.push(u);
    } else {
      // fallback: detectar dom√≠nios sem esquema (ex: example.com/abc)
      const domainLike = ln.match(/([^\s]+\.[a-z]{2,}(\/[^\s]*)?)/i);
      if(domainLike && domainLike[1]) {
        urls.push(domainLike[1]);
      }
    }
  }

  // Garantir primeiro link/string ap√≥s o t√≠tulo como downloadUrl
  if(urls.length > 0){
    downloadUrl = urls[0];
    if(urls.length >= 2) pageUrl = urls[1];
    if(urls.length >= 3) imageUrl = imageUrl || urls[2];
    if(!imageUrl){
      const last = urls[urls.length - 1];
      if(/\.(png|jpe?g|webp|gif|svg)(\?|$)/i.test(last)) imageUrl = last;
    }
  }

  let category = currentCategory || 'Indie';
  const normalizedTags = tags.map(t => t.trim()).filter(Boolean);
  return { title, category, downloadUrl, pageUrl, imageUrl, rawLines: lines, tags: normalizedTags };
}

// ========= Fun√ß√£o que cria bot√µes de filtro din√¢micos =========
function createFilterButtons(filters) {
  const container = document.getElementById('dynamicFilters');
  container.innerHTML = ''; // limpa
  if(!filters || filters.length === 0) return;
  // bot√£o "Limpar filtro"
  const clearBtn = document.createElement('button');
  clearBtn.className = 'filter-btn';
  clearBtn.textContent = 'Mostrar tudo';
  clearBtn.onclick = function(){
    activeFilter = null;
    // remover classe active de todos
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    clearBtn.classList.add('active');
    filterAndShow();
  };
  container.appendChild(clearBtn);
  // inicialmente "Mostrar tudo" ativo
  clearBtn.classList.add('active');

  for(const f of filters){
    const b = document.createElement('button');
    b.className = 'filter-btn';
    b.textContent = f;
    b.dataset.filter = f;
    b.onclick = function(){
      // toggle single-active behavior
      const wasActive = b.classList.contains('active');
      // limpar todos
      document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
      if(!wasActive){
        b.classList.add('active');
        activeFilter = b.dataset.filter;
      } else {
        // se clicar no ativo, remove filtro e ativa "Mostrar tudo"
        activeFilter = null;
        clearBtn.classList.add('active');
      }
      filterAndShow();
    };
    container.appendChild(b);
  }
}

// ========= Nova fun√ß√£o: cria abas (tabs) de categoria dinamicamente, preservando "All" e "Requests" =========
function createCategoryTabs(categories){
  // categories: array em ordem de apari√ß√£o (strings)
  const tabGroup = document.getElementById('tabGroup');
  tabGroup.innerHTML = ''; // limpa
  // bot√£o All (sempre)
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.dataset.cat = 'all';
  allBtn.type = 'button';
  allBtn.textContent = 'All';
  tabGroup.appendChild(allBtn);

  // dedupe e manter ordem, mas s√≥ adicionar categorias v√°lidas
  const seen = new Set();
  for(const c of categories){
    if(!c) continue;
    const label = c.trim();
    if(!label) continue;
    if(seen.has(label)) continue;
    seen.add(label);
    const b = document.createElement('button');
    b.className = 'tab';
    b.dataset.cat = label;
    b.type = 'button';
    b.textContent = label;
    tabGroup.appendChild(b);
  }
  // adicionar alguns defaults se n√£o presentes
  ['Indie','AAA','NSFW'].forEach(d=> {
    if(!seen.has(d)) {
      const b = document.createElement('button');
      b.className = 'tab';
      b.dataset.cat = d;
      b.type = 'button';
      b.textContent = d;
      tabGroup.appendChild(b);
    }
  });
  // garantir All ativo
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  const all = document.querySelector('.tab[data-cat="all"]');
  if(all) all.classList.add('active');
}

// ========= Atualizei makeCard para incluir data-tags =========
function makeCard(item){
  const el = document.createElement('div');
  el.className='card';
  el.dataset.title=item.title.toLowerCase();
  el.dataset.category=item.category;
  el.dataset.tags = (item.tags && item.tags.length) ? item.tags.join(',').toLowerCase() : ''; // para filtragem
  const thumb = document.createElement('div');
  thumb.className='thumb';
  if(currentDevice==='pc' && item.pageUrl && item.pageUrl.includes('steampowered.com/app/')){ 
    const appIdMatch = item.pageUrl.match(/\/app\/(\d+)/);
    if(appIdMatch){
      const appId = appIdMatch[1];
      const img = document.createElement('img');
      img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/header.jpg`;
      img.alt = '';
      thumb.appendChild(img);
    }else{
      thumb.textContent = 'No Image';
    }
  }
  else if(currentDevice==='android'){
    if(item.imageUrl){
      const img = document.createElement('img');
      img.src = item.imageUrl;
      img.alt = '';
      thumb.appendChild(img);
    }else if(item.pageUrl && item.pageUrl.includes('play.google.com/store/apps')){
      const img = document.createElement('img');
      img.src = 'https://play-lh.googleusercontent.com/ogw/AOLn63E8Koz5A9iVgX2WWv7jDrXw7W3wYw6iUP3Fa9fN=s32-c-mo';
      img.alt = '';
      thumb.appendChild(img);
    }else{
      thumb.textContent = 'No Image';
    }
  }
  else{
    thumb.textContent = 'No Image';
  }
  const titleDiv = document.createElement('div');
  const metaText = item.tags && item.tags.length ? `${item.category} ¬∑ ${item.tags.join(', ')}` : `${item.category}`;
  titleDiv.innerHTML = `<div class="title">${escapeHtml(item.title)}</div><div class="meta">${escapeHtml(metaText)}</div>`;
  const buttons = document.createElement('div');
  buttons.className='buttons';
  if(item.downloadUrl){
    const aDl=document.createElement('a');
    aDl.className='btn primary';
    try {
      let decoded = caesarDecodeLettersDigits(item.downloadUrl, 3);
      if(!/[A-Za-z][A-Za-z0-9+.\-]*:\/\//.test(decoded) && /^[^\s]+\.[a-z]{2,}/i.test(decoded)) {
        decoded = 'http://' + decoded;
      }
      aDl.href = decoded;
    } catch (e) {
      aDl.href = item.downloadUrl;
    }
    aDl.target='_blank';
    aDl.rel='noopener';
    aDl.textContent='Download';
    buttons.appendChild(aDl);
  }
  if(currentDevice==='pc' && item.pageUrl && item.pageUrl.includes('steampowered.com/app/')){
    const aSteam = document.createElement('a');
    aSteam.className='btn ghost';
    aSteam.href=item.pageUrl;
    aSteam.target='_blank';
    aSteam.rel='noopener';
    aSteam.textContent='Steam Page';
    buttons.appendChild(aSteam);
  }
  if(currentDevice==='android' && item.pageUrl && item.pageUrl.includes('play.google.com/store/apps')){
    const aPlay = document.createElement('a');
    aPlay.className='btn ghost';
    aPlay.href=item.pageUrl;
    aPlay.target='_blank';
    aPlay.rel='noopener';
    aPlay.textContent='Google Play Page';
    buttons.appendChild(aPlay);
  }
  el.appendChild(thumb);
  el.appendChild(titleDiv);
  el.appendChild(buttons);
  return el;
}

// ========= Render grid =========
function renderGrid(items){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  window.currentItems=items;
  const frag=document.createDocumentFragment();
  for(const it of items) frag.appendChild(makeCard(it));
  grid.appendChild(frag);
  filterAndShow();
}

// ========= Filtragem (search + tab + activeFilter) =========
function filterAndShow() {
  const query = (document.getElementById('search').value || '').toLowerCase();
  const catBtn = document.querySelector('.tab.active');
  let cat = catBtn ? catBtn.dataset.cat : 'all';
  cat = cat.toLowerCase();
  const grid = document.getElementById('grid');
  Array.from(grid.children).forEach(card => {
    const cardCat = (card.dataset.category || '').toLowerCase();
    const matchTitle = card.dataset.title.includes(query);
    const matchCat = (cat === 'all') || (cardCat === cat);
    // checar filtro ativo (tags)
    let matchFilter = true;
    if(activeFilter){
      const tags = (card.dataset.tags || '').toLowerCase();
      matchFilter = tags.split(',').map(x=>x.trim()).filter(Boolean).includes(activeFilter.toLowerCase());
    }
    card.style.display = (matchTitle && matchCat && matchFilter) ? '' : 'none';
  });
}

// ========= Ordena√ß√£o e colunas =========
function applySortAndReorder(){
  const sort = document.getElementById('sortSelect').value;
  const grid = document.getElementById('grid');
  let cards = Array.from(grid.children);
  if(sort === 'alpha'){
    cards = cards.sort((a,b)=>a.dataset.title.localeCompare(b.dataset.title));
  }
  grid.innerHTML = '';
  for(const card of cards) grid.appendChild(card);
  filterAndShow();
}
function applyColumns(cols){
  cols = Math.max(1, Math.min(8, parseInt(cols)));
  document.documentElement.style.setProperty('--cols', cols);
  localStorage.setItem('gridColumns', cols);
}

// ========= Carregamento de arquivo + cria√ß√£o de bot√µes de filtro din√¢micos e abas de categoria =========
function loadGames(device){
  fetch(FILES[device] + '?cacheBust=' + Date.now())
    .then(res=>res.text())
    .then(txt=>{
      // extrai filtros globais do txt e cria bot√µes
      const filters = extractFiltersFromTxt(txt);
      // extrai categorias do txt (novidade)
      const categories = extractCategoriesFromTxt(txt);
      // cria dinamicamente as abas de categoria (mantendo ordem)
      createCategoryTabs(categories);
      // se n√£o houver filtros globais, tente extrair unicamente das tags dos blocos
      if(!filters || filters.length === 0) {
        const itemsTemp = (function(){ try{ return parseGamesTxt(txt); }catch(e){ return []; } })();
        const auto = new Set();
        itemsTemp.forEach(it => { if(it.tags && it.tags.length) it.tags.forEach(t=>auto.add(t)); });
        createFilterButtons(Array.from(auto));
      } else {
        createFilterButtons(filters);
      }
      // renderiza itens completos
      renderGrid(parseGamesTxt(txt));
    })
    .catch(e=>{
      document.getElementById('grid').innerHTML = `<div style="color:#e74c3c;padding:20px;">Erro ao carregar lista: ${escapeHtml(e.message)}</div>`;
    });
}

// ================== Requests / GitHub (mantidos) ==================
const REPO = 'LucyYuih/Games-that-fell-off-the-truck';
const ISSUES_API = `https://api.github.com/repos/${REPO}/issues`;
let githubToken = null;
let githubUser = null;
function showLoginError(msg){
  document.getElementById('loginError').textContent = msg;
  document.getElementById('loginError').style.display = 'block';
}
function updateLoginUI(){
  if(githubUser){
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('loginSuccess').style.display = 'block';
    document.getElementById('githubUsername').textContent = githubUser.login;
    if(githubUser.avatar_url){
      document.getElementById('userAvatar').src = githubUser.avatar_url;
      document.getElementById('userAvatar').style.display = '';
      document.getElementById('defaultAvatar').style.display = 'none';
    }else{
      document.getElementById('userAvatar').style.display = 'none';
      document.getElementById('defaultAvatar').style.display = '';
    }
    document.getElementById('myRequestsViewTab').style.display = '';
  }else{
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('loginSuccess').style.display = 'none';
    document.getElementById('myRequestsViewTab').style.display = 'none';
  }
  document.getElementById('loginError').style.display = 'none';
}
async function authenticateWithGitHub(username, token){
  document.getElementById('loginSpinner').style.display = '';
  document.getElementById('githubLoginBtn').disabled = true;
  try{
    const res = await fetch('https://api.github.com/user', {
      headers: { Authorization: 'token ' + token }
    });
    if(!res.ok) throw new Error('Invalid token');
    githubUser = await res.json();
    githubToken = token;
    localStorage.setItem('github_token', token);
    localStorage.setItem('github_user', JSON.stringify(githubUser));
    updateLoginUI();
  }catch(e){
    showLoginError('GitHub authentication failed: ' + e.message);
  }
  document.getElementById('loginSpinner').style.display = 'none';
  document.getElementById('githubLoginBtn').disabled = false;
}
function switchRequestView(view){
  document.getElementById('allRequestsViewTab').classList.toggle('active', view === 'all');
  document.getElementById('myRequestsViewTab').classList.toggle('active', view === 'my');
  loadRequests(view);
}
function switchRequestStatus(status){
  document.getElementById('openRequestsTab').classList.toggle('active', status === 'open');
  document.getElementById('closedRequestsTab').classList.toggle('active', status === 'closed');
  loadRequests(null, status);
}
async function submitRequest(){
  if(!githubToken){
    showLoginError('You must be logged in to submit a request.');
    return;
  }
  const title = document.getElementById('requestTitle').value.trim();
  const category = document.getElementById('requestCategory').value.trim();
  const link = document.getElementById('requestLink').value.trim();
  const description = document.getElementById('requestDescription').value.trim();
  if(!title || !category || !link){
    showLoginError('Please fill in all required fields.');
    return;
  }
  const body = `**Category:** ${category}\n**Link:** ${link}\n\n${description}`;
  document.getElementById('submitRequest').disabled = true;
  try{
    const res = await fetch(ISSUES_API, {
      method: 'POST',
      headers: {
        Authorization: 'token ' + githubToken,
        Accept: 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({ title, body })
    });
    if(res.status === 201){
      document.getElementById('requestForm').reset();
      loadRequests();
      alert('Request submitted!');
    }else{
      const err = await res.json();
      showLoginError('Request failed: ' + (err.message || res.status));
    }
  }catch(e){
    showLoginError('Error submitting request: '+e.message);
  }
  document.getElementById('submitRequest').disabled = false;
}
async function loadRequests(view, status){
  const grid = document.getElementById('requestsGrid');
  grid.innerHTML = '<div style="color:#97a0ac;padding:20px;">Loading requests...</div>';
  let url = ISSUES_API + '?per_page=50&state=all';
  try{
    const res = await fetch(url);
    const issues = await res.json();
    let filtered = issues;
    if(status === 'open') filtered = issues.filter(i=>i.state==='open');
    if(status === 'closed') filtered = issues.filter(i=>i.state==='closed');
    if(view === 'my' && githubUser) filtered = filtered.filter(i=>i.user.login===githubUser.login);
    grid.innerHTML = '';
    for(const issue of filtered) grid.appendChild(makeRequestCard(issue));
    if(filtered.length === 0) grid.innerHTML = '<div style="color:#97a0ac;padding:20px;">No requests found.</div>';
  }catch(e){
    grid.innerHTML = '<div style="color:#e74c3c;padding:20px;">Error loading requests: '+e.message+'</div>';
  }
}
function makeRequestCard(issue){
  const el = document.createElement('div');
  el.className = 'request-card';
  const statusClass = issue.state === 'open' ? 'status-open' : 'status-closed';
  el.innerHTML = `
    <div class="request-title">${escapeHtml(issue.title)}</div>
    <div class="request-meta">
      <span class="request-category">${extractCategory(issue.body)}</span>
      <a class="request-link" href="${extractLink(issue.body)}" target="_blank">Link</a>
      <span>by <b>${escapeHtml(issue.user.login)}</b></span>
    </div>
    <div class="request-body">${escapeHtml(extractDescription(issue.body))}</div>
    <div class="request-status ${statusClass}">${issue.state.toUpperCase()}</div>
    <a href="${issue.html_url}" target="_blank" style="color:${issue.state==='open'?'#7c5cf7':'#e74c3c'};font-size:13px;">View on GitHub</a>
  `;
  return el;
}
function extractCategory(body){
  const m = body.match(/\*\*Category:\*\*\s*([^\n]+)/);
  return m ? m[1] : "N/A";
}
function extractLink(body){
  const m = body.match(/\*\*Link:\*\*\s*(https?:\/\/[^\s]+)/);
  return m ? m[1] : "#";
}
function extractDescription(body){
  return body.replace(/\*\*Category:.*\*\*Link:.*\n*/s,'').trim();
}

// ========= Event listeners e inicializa√ß√£o =========
document.addEventListener('DOMContentLoaded', ()=> {
  document.getElementById('btnPC').onclick = function(){
    if(currentDevice==='pc') return;
    currentDevice='pc';
    document.getElementById('btnPC').classList.add('active');
    document.getElementById('btnAndroid').classList.remove('active');
    activeFilter = null;
    loadGames('pc');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelector('.tab[data-cat="all"]').classList.add('active');
    document.getElementById('grid').style.display = 'grid';
    document.getElementById('requestSection').style.display = 'none';
    updateUrlState('all', document.getElementById('sortSelect').value, 'pc');
  };
  document.getElementById('btnAndroid').onclick = function(){
    if(currentDevice==='android') return;
    currentDevice='android';
    document.getElementById('btnPC').classList.remove('active');
    document.getElementById('btnAndroid').classList.add('active');
    activeFilter = null;
    loadGames('android');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelector('.tab[data-cat="all"]').classList.add('active');
    document.getElementById('grid').style.display = 'grid';
    document.getElementById('requestSection').style.display = 'none';
    updateUrlState('all', document.getElementById('sortSelect').value, 'android');
  };

  // delega√ß√£o para cliques nas tabs (tabGroup)
  document.getElementById('tabGroup').onclick = function(e){
    const b = e.target.closest('.tab');
    if(!b || b.dataset.cat==='requests') return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById('grid').style.display = 'grid';
    document.getElementById('requestSection').style.display = 'none';
    filterAndShow();
    updateUrlState(b.dataset.cat, document.getElementById('sortSelect').value, currentDevice);
  };

  document.getElementById('requestsTab').onclick = function(){
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('grid').style.display = 'none';
    document.getElementById('requestSection').style.display = 'block';
    loadRequests();
    updateUrlState('requests','default',currentDevice);
  };

  document.getElementById('sortSelect').addEventListener('change', function(){
    applySortAndReorder();
    updateUrlState(getActiveTab(), this.value, currentDevice);
  });
  document.getElementById('search').addEventListener('input', filterAndShow);

  const zoomSlider = document.getElementById('zoomSlider');
  const colsCount = document.getElementById('colsCount');
  if (zoomSlider) {
    zoomSlider.addEventListener('input', e => {
      applyColumns(e.target.value);
      colsCount.textContent = e.target.value;
    });
    const savedCols = parseInt(localStorage.getItem('gridColumns') || getComputedStyle(document.documentElement).getPropertyValue('--cols') || 3, 10);
    zoomSlider.value = Math.min(8, Math.max(1, savedCols));
    colsCount.textContent = zoomSlider.value;
    applyColumns(zoomSlider.value);
  }
  const optionsBtn = document.getElementById('optionsBtn');
  const optionsMenu = document.getElementById('optionsMenu');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', ()=> {
      const isVisible = optionsMenu.classList.contains('show');
      if (isVisible) {
        optionsMenu.classList.remove('show');
        optionsMenu.setAttribute('aria-hidden', 'true');
      } else {
        optionsMenu.classList.add('show');
        optionsMenu.setAttribute('aria-hidden', 'false');
      }
    });
  }
  document.addEventListener('click', (e) => {
    if (optionsMenu && !optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
      optionsMenu.classList.remove('show');
      optionsMenu.setAttribute('aria-hidden', 'true');
    }
  });

  document.getElementById('submitRequest').addEventListener('click', submitRequest);
  document.getElementById('githubLoginBtn').addEventListener('click', async () => {
    const username = document.getElementById('githubUsernameInput').value.trim();
    const token = document.getElementById('githubTokenInput').value.trim();
    if (!username || !token) {
      showLoginError('Please enter both username and token');
      return;
    }
    await authenticateWithGitHub(username, token);
  });
  document.getElementById('githubLogoutBtn').addEventListener('click', () => {
    githubToken = null;
    githubUser = null;
    localStorage.removeItem('github_token');
    localStorage.removeItem('github_user');
    updateLoginUI();
    document.getElementById('myRequestsViewTab').style.display = 'none';
    switchRequestView('all');
  });
  document.getElementById('allRequestsViewTab').addEventListener('click', () => switchRequestView('all'));
  document.getElementById('myRequestsViewTab').addEventListener('click', () => switchRequestView('my'));
  document.getElementById('openRequestsTab').addEventListener('click', () => switchRequestStatus('open'));
  document.getElementById('closedRequestsTab').addEventListener('click', () => switchRequestStatus('closed'));

  const savedToken = localStorage.getItem('github_token');
  const savedUser = localStorage.getItem('github_user');
  if(savedToken && savedUser){
    githubToken = savedToken;
    try{ githubUser = JSON.parse(savedUser); }catch(e){}
    updateLoginUI();
  }

  // initial load: read URL state (device/tab) if houver
  const urlState = readStateFromLocation();
  if(urlState.device && (urlState.device==='pc'||urlState.device==='android')) currentDevice = urlState.device;
  document.getElementById('btnPC').classList.toggle('active', currentDevice==='pc');
  document.getElementById('btnAndroid').classList.toggle('active', currentDevice==='android');
  // load and create filters/buttons accordingly
  loadGames(currentDevice);

  setTimeout(()=>{ try{ restoreStateFromLocation(); }catch(e){} }, 400);
  window.addEventListener('hashchange', () => { try { restoreStateFromLocation(); } catch(e){} });
  window.addEventListener('popstate', () => { try { restoreStateFromLocation(); } catch(e){} });
});

// ========== URL state helpers (ajustados p/ categorias din√¢micas) =========
function getActiveTab() {
  const active = document.querySelector('.tab.active');
  return (active && active.dataset && active.dataset.cat) ? active.dataset.cat : 'all';
}
function getActiveDevice() {
  return currentDevice || "pc";
}
function buildStatePath(tab, sort, device) {
  device = (device || getActiveDevice() || 'pc').toLowerCase();
  tab = (tab || 'all').toString().toLowerCase();
  sort = (sort || 'default').toString().toLowerCase();
  if (tab === 'requests') {
    return `/${encodeURIComponent(device)}/${encodeURIComponent(tab)}`;
  }
  if (!sort || sort === 'default') {
    return `/${encodeURIComponent(device)}/${encodeURIComponent(tab)}`;
  }
  return `/${encodeURIComponent(device)}/${encodeURIComponent(tab)}/${encodeURIComponent(sort)}`;
}
function parseStateFromHash(hash) {
  if (!hash) return null;
  const cleaned = hash.replace(/^#(!)?/, '');
  if (!cleaned) return null;
  const parts = cleaned.replace(/^\/+|\/+$/g,'').split('/');
  const device = (parts[0] || 'pc').toLowerCase();
  const tab = (parts[1] || 'all').toLowerCase();
  const sort = (parts[2] || 'default').toLowerCase();
  return { device, tab, sort };
}
function parseStateFromPathname(path) {
  if (!path) return null;
  const p = path.split('?')[0].split('#')[0];
  const clean = p.replace(/^\/+|\/+$/g,'');
  if (!clean) return { device: 'pc', tab: 'all', sort: 'default' };
  const parts = clean.split('/');
  const device = (parts[0] || 'pc').toLowerCase();
  const tab = (parts[1] || 'all').toLowerCase();
  const sort = (parts[2] || 'default').toLowerCase();
  return { device, tab, sort };
}
function readStateFromLocation() {
  const fromHash = parseStateFromHash(location.hash);
  if (fromHash) return fromHash;
  const fromPath = parseStateFromPathname(location.pathname);
  if (fromPath) return fromPath;
  return { device: 'pc', tab: 'all', sort: 'default' };
}
function updateUrlState(tab, sort, device) {
  device = (device || getActiveDevice() || 'pc').toLowerCase();
  tab = (tab || 'all').toString().toLowerCase();
  sort = (sort || 'default').toString().toLowerCase();
  const useHashRouting = (function(){
    try {
      if (location.protocol === 'file:') return true;
      const host = (location.hostname || '').toLowerCase();
      if (host.includes('github.io')) return true;
    } catch(e){}
    return false;
  })();
  try {
    const path = buildStatePath(tab, sort, device);
    if (useHashRouting) {
      const hash = '#' + path;
      if (location.hash !== hash) {
        history.replaceState(null, '', location.pathname + hash);
      }
    } else {
      const newUrl = path;
      if (location.pathname !== newUrl || location.search !== '') {
        history.replaceState(null, '', newUrl + location.search + location.hash);
      }
    }
  } catch (e) {
    console.warn('updateUrlState failed', e);
  }
}
function restoreStateFromLocation(){
  const state = readStateFromLocation();
  if (state.device && (state.device === 'pc' || state.device === 'android') && state.device !== currentDevice) {
    currentDevice = state.device;
    document.getElementById('btnPC').classList.toggle('active', currentDevice==='pc');
    document.getElementById('btnAndroid').classList.toggle('active', currentDevice==='android');
    loadGames(currentDevice);
  }
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  let foundTab = null;
  document.querySelectorAll('.tab').forEach(tabEl=>{
    if(tabEl.dataset.cat && tabEl.dataset.cat.toLowerCase() === state.tab) {
      foundTab = tabEl;
    }
  });
  if(foundTab) foundTab.classList.add('active');
  else {
    const fallback = document.querySelector('.tab[data-cat="all"]');
    if(fallback) fallback.classList.add('active');
  }
  if(state.tab === 'requests'){
    document.getElementById('grid').style.display = 'none';
    document.getElementById('requestSection').style.display = 'block';
  }else{
    document.getElementById('grid').style.display = 'grid';
    document.getElementById('requestSection').style.display = 'none';
  }
  if(document.getElementById('sortSelect')){
    document.getElementById('sortSelect').value = state.sort || 'default';
    applySortAndReorder();
  }
  filterAndShow();
}
</script>
</body>
</html>
