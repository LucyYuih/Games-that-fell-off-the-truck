<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Games that fell off the truck</title>
<style>
:root{
  --bg:#0b0f14;
  --muted:#97a0ac;
  --accent:#7c5cf7;
  --glass: rgba(255,255,255,0.03);
  --radius:14px;
  --gap:18px;

  --cols: 3;
  --card-scale: 1;
  --title-size: calc(15px * var(--card-scale));
  --meta-size: calc(12px * var(--card-scale));
  --btn-font: calc(13px * var(--card-scale));
  --btn-padding-vert: calc(8px * var(--card-scale));
  --btn-padding-horiz: calc(10px * var(--card-scale));
  --thumb-aspect: 16 / 9;
}

/* reset / base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#07090c 0%, #0b0f14 100%);color:#e6eef8;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto,Arial;overflow-x:hidden;}
.app{max-width:1200px;margin:28px auto;padding:20px;}
header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
.brand{display:flex;gap:12px;align-items:center;}
.square{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#4bb6ff);font-weight:800;color:#06111a;font-size:20px;}
.titleWrap{display:flex;flex-direction:column;}
.titleWrap h1{font-size:18px;margin:0}
.titleWrap .lead{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.search{background:var(--glass);padding:10px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;min-width:160px;max-width:420px;}
.search input{background:transparent;border:0;color:inherit;outline:none;font-size:14px;width:100%;min-width:0;}

/* sort selector */
.sort-wrap{display:flex;align-items:center;gap:8px;margin-left:8px}
.sort-select{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:inherit;font-weight:600}

/* tabs */
.tabs{display:flex;gap:8px;padding:12px 0;margin-bottom:12px;align-items:center;flex-wrap:wrap;}
.tab-group{display:flex;gap:8px;flex:1;align-items:center;flex-wrap:wrap;}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:600;font-size:13px;}
.tab.active{background:linear-gradient(90deg, rgba(124,92,247,0.12), rgba(75,182,255,0.06));border-color:transparent;color:#e9f0ff;box-shadow:0 6px 20px rgba(16,18,22,0.4)}
.tab.requests-tab{margin-left:auto;background:linear-gradient(90deg,#4bb6ff,#7c5cf7);color:#06111a;border:0;box-shadow:0 8px 30px rgba(75,182,255,0.12);}

/* grid: responsive columns via --cols; use minmax(0,1fr) so columns shrink */
.grid{
  display:grid;
  gap:var(--gap);
  grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
  align-items:start;
  overflow:auto;
  padding-bottom:6px;
  transition:all 0.18s ease;
  width:100%;
}

/* CARD */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  padding:calc(12px * var(--card-scale));
  border-radius:var(--radius);
  display:flex;
  flex-direction:column;
  gap:calc(10px * var(--card-scale));
  border:1px solid rgba(255,255,255,0.03);
  transition:transform 0.18s ease;
}

/* thumb */
.thumb{
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  background:linear-gradient(135deg,#07101a,#0b1420);
  box-shadow:inset 0 -20px 40px rgba(0,0,0,0.35);
  aspect-ratio: var(--thumb-aspect);
  width:100%;
  min-height:60px;
}
.thumb img{width:100%;height:100%;object-fit:cover;display:block;transition: opacity 0.25s ease;}

/* scaled text & buttons inside cards */
.card .title{font-size:var(--title-size);margin:0;color:#eaf2ff;font-weight:700;line-height:1.15}
.card .meta{font-size:var(--meta-size);color:var(--muted);display:block;margin-top:-2px}

/* global button style */
.btn{
  flex:0 0 auto;
  padding:8px 10px;
  border-radius:10px;
  border:0;
  background:transparent;
  color:#cfe3ff;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.04);
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-height:32px;
}

/* buttons inside cards: equal width */
.card .btn{
  flex:1 1 0;
  padding: var(--btn-padding-vert) var(--btn-padding-horiz);
  font-size: var(--btn-font);
  min-height: calc(32px * var(--card-scale));
  min-width: 0;
}

/* variants */
.btn.primary{background:linear-gradient(90deg,var(--accent),#4bb6ff);color:#06111a;box-shadow:0 8px 30px rgba(124,92,247,0.12);border:0}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
.btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
.extra-buttons{display:flex;gap:6px;flex-wrap:wrap;flex:1 1 100%}
.card .buttons { display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%; }

/* options */
.options-container { position: relative; margin-left: auto; }
.options-menu { display: none; position: absolute; top: 110%; right: 0; background: var(--glass); backdrop-filter: blur(8px); border-radius: 10px; padding: 12px; min-width: 160px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 20; }
.options-menu.show { display: flex; align-items: center; gap: 12px; }
.options-menu input[type=range]{ -webkit-appearance: none; appearance: none; width:140px; height:8px; background: linear-gradient(90deg,#2b3340,#111418); border-radius:6px; outline:none; }
.options-menu input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:20px;height:20px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#4bb6ff);box-shadow:0 6px 18px rgba(0,0,0,0.4); }
.options-menu input[type=range]::-moz-range-thumb{ width:20px;height:20px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#4bb6ff);border:0; }
.cols-count{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px; font-weight:800; color:#eaf2ff; min-width:38px; text-align:center; font-size:14px; }

/* requests */
.request-form { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03)); border-radius: var(--radius); padding: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px; display: none; }
.form-group { margin-bottom: 16px; }
.form-control { width:100%; padding:10px 12px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:10px; color:#eaf2ff; }
.requests-grid { display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
.request-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding: 16px; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.03); position: relative; box-shadow: 0 4px 18px rgba(0,0,0,0.35); }
.request-title{font-size:16px;margin:8px 0;font-weight:700;color:#eaf2ff}
.request-meta { color: var(--muted); font-size:13px; margin-bottom: 10px; display:flex; gap:12px; align-items:center; }
.request-category { display:inline-block; padding:4px 10px; background: rgba(124,92,247,0.1); border-radius:6px; color:#c6b3ff; font-weight:700; font-size:13px;}
.request-body{font-size:14px;color:#d0d8e3;line-height:1.4;margin-bottom:8px}
.request-status { position:absolute; top:16px; right:16px; font-size:11px; padding:6px 8px; border-radius:6px; font-weight:700; }
.request-tabs { display:flex; gap:8px; margin:12px 0; }
.request-tab { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:700; cursor:pointer; font-size:13px; }
.request-tab.active { background: linear-gradient(90deg, rgba(124,92,247,0.14), rgba(75,182,255,0.08)); color:#eaf2ff; border:0; box-shadow:0 8px 20px rgba(0,0,0,0.35); }
.request-view-tab { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:10px 16px; border-radius:12px; background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--muted); font-weight:700; cursor:pointer; font-size:14px; transition: all 0.2s ease; }
.request-view-tab.active { background: linear-gradient(90deg, rgba(124,92,247,0.18), rgba(75,182,255,0.12)); color:#eaf2ff; border:0; box-shadow:0 10px 25px rgba(0,0,0,0.4); transform: translateY(-1px); }
.status-open { background: rgba(46, 204, 113, 0.12); color: #2ecc71; border:1px solid rgba(46,204,113,0.08) }
.status-closed { background: rgba(231, 76, 60, 0.12); color: #e74c3c; border:1px solid rgba(231,76,60,0.08) }
.request-link { color: #7c5cf7; text-decoration:none; font-weight:700 }

/* spinner */
.thumb .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.footer{color:var(--muted);font-size:12px;margin-top:14px;text-align:center}

/* ------------------------------
   Modal warning styles (desktop/Edge tuned)
   ------------------------------ */
#siteWarningModalOverlay{
  position:fixed;
  inset:0;
  background:rgba(2,6,12,0.7);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  -webkit-overflow-scrolling: touch;
  overflow:auto;
}
#siteWarningModal{
  background:linear-gradient(180deg, #0f1720 0%, #07101a 100%);
  border-radius:12px;
  max-width:900px;
  width:100%;
  color:#eaf2ff;
  box-shadow:0 24px 60px rgba(2,6,12,0.8);
  border:1px solid rgba(255,255,255,0.04);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  max-height: calc(100vh - 80px);
}
#siteWarningModal header{
  padding:18px 20px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex: 0 0 auto;
}
#siteWarningModal header h3{margin:0;font-size:18px}
#siteWarningModal .modal-body{
  padding:18px 20px;
  display:flex;
  gap:18px;
  flex-direction:column;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  flex: 1 1 auto;
  max-height: calc(100vh - 160px);
}
#siteWarningModal .warning-text{font-size:14px;color:#ffd6d6;background:rgba(231,76,60,0.06);padding:10px;border-radius:8px;border:1px solid rgba(231,76,60,0.08)}
#siteWarningModal .hint{font-size:13px;color:var(--muted)}
#siteWarningModal video{max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#000;max-height:60vh;height:auto}
#siteWarningModal .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid rgba(255,255,255,0.02)}
#siteWarningModal .modal-actions .btn{min-width:120px}
#siteWarningModal .learn-more{font-size:13px;color:var(--muted);text-decoration:underline;cursor:pointer}

/* small screens: stack video below text */
@media (min-width:720px){
  #siteWarningModal .modal-body{flex-direction:row;align-items:flex-start}
  #siteWarningModal .modal-col{flex:1}
  #siteWarningModal .modal-video{flex:1;max-width:420px}
}
@media (max-width:719px){
  #siteWarningModal{max-width:480px; max-height: 100vh;}
  #siteWarningModal .modal-body{max-height: calc(100vh - 120px);}
}
</style>
</head>
<body>
  <div class="app">
    <!-- MODAL WARNING -->
    <div id="siteWarningModalOverlay" style="display:none;" aria-hidden="true">
      <div id="siteWarningModal" role="dialog" aria-modal="true" aria-labelledby="siteWarningTitle">
        <header>
          <h3 id="siteWarningTitle">Important Notice â€” Safety</h3>
          <button id="siteWarningClose" class="btn ghost" type="button" aria-label="Close notice">Close</button>
        </header>
        <div class="modal-body">
          <div class="modal-col">
            <div class="warning-text">
              Please <strong>do not download anything from outside the website <span style="color:#7c5cf7;">ranoz.gg</span></strong> â€” files from external sources may contain unwanted or malicious content.
            </div>
            <p class="hint" style="margin-top:10px;">
              If you're having trouble downloading or installing, watch the tutorial video on the right â€” it is located in the same folder as this page.
            </p>
          </div>
          <div class="modal-col modal-video" style="display:flex;flex-direction:column;gap:8px;align-items:stretch">
            <video id="siteTutorialVideo" controls preload="metadata" poster="" tabindex="0">
              <source src="tutorial.mp4" type="video/mp4">
              Your browser does not support HTML5 video â€” open the file tutorial.mp4 in the same folder.
            </video>
            <div style="display:flex;justify-content:flex-end;align-items:center;">
              <button id="siteWarningGotIt" class="btn primary" type="button">Got it</button>
              <button id="siteWarningDontShow" class="btn ghost" type="button" style="margin-left:8px;">Donâ€™t show again</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END WARNING MODAL -->
    <header>
      <div class="brand">
        <div class="square">ðŸŽ®</div>
        <div class="titleWrap">
          <h1>Games that fell off the truck</h1>
          <div class="lead">Games rescued from the wild</div>
        </div>
      </div>
      <div class="controls">
        <div style="display:flex;align-items:center">
          <div class="search" title="Search by name">
            ðŸ”Ž <input id="search" placeholder="Search by name..." />
          </div>
          <div class="sort-wrap">
            <label for="sortSelect" style="font-size:13px;color:var(--muted)">Sort:</label>
            <select id="sortSelect" class="sort-select" title="Sort games">
              <option value="default">Default</option>
              <option value="alpha">Alphabetical</option>
              <option value="recent">Most Recent Added</option>
            </select>
          </div>
        </div>
        <div class="options-container">
          <button id="optionsBtn" class="btn ghost" type="button">âš™ Options</button>
          <div id="optionsMenu" class="options-menu" aria-hidden="true">
            <input type="range" id="zoomSlider" min="1" max="8" step="1" />
            <div class="cols-count" id="colsCount">3</div>
          </div>
        </div>
      </div>
    </header>
    <nav class="tabs" id="tabs">
      <div class="tab-group" id="tabGroup">
        <button class="tab active" data-cat="all" type="button">All</button>
        <button class="tab" data-cat="Games" type="button">Games</button>
        <button class="tab" data-cat="Indie" type="button">Indie</button>
        <button class="tab" data-cat="AAA" type="button">AAA</button>
      </div>
      <button class="tab requests-tab" data-cat="requests" id="requestsTab" type="button">Requests</button>
    </nav>
    <main>
      <section id="grid" class="grid" aria-live="polite"></section>
      <!-- Request Section -->
      <section id="requestSection" style="display: none;">
        <form class="request-form" id="requestForm" novalidate>
          <h2>Request a Game</h2>
          <p style="margin-bottom: 16px; color: var(--muted);">Submit your request for a new game to be added to the collection (requires GitHub login).</p>
          <!-- GitHub Login Section -->
          <div id="githubLoginSection" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
            <div id="loginForm" style="display: block;">
              <h3 style="margin: 0 0 12px 0; color: #eaf2ff; font-size: 16px;">GitHub Authentication</h3>
              <p style="margin: 0 0 16px 0; color: var(--muted); font-size: 14px;">Login with your GitHub Personal Access Token to submit and manage requests</p>
              <div class="form-group" style="margin-bottom: 12px;">
                <label for="githubUsername" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">GitHub Username*</label>
                <input type="text" id="githubUsernameInput" class="form-control" placeholder="your-github-username" required>
              </div>
              <div class="form-group" style="margin-bottom: 16px;">
                <label for="githubToken" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">Personal Access Token*</label>
                <input type="password" id="githubTokenInput" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                <small style="display: block; margin-top: 4px; color: var(--muted); font-size: 12px;">
                  <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--accent); text-decoration: none;">Create a token</a> with 'repo' and 'user' scopes
                </small>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button id="githubLoginBtn" class="btn primary" type="button">Login</button>
                <div id="loginSpinner" style="display: none;">
                  <div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
              </div>
              <div id="loginError" style="display: none; margin-top: 12px; padding: 10px; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.2); border-radius: 6px; color: #e74c3c;"></div>
            </div>
            <div id="loginSuccess" style="display: none;">
              <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <img id="userAvatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; display: none;">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center;" id="defaultAvatar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  </div>
                  <div>
                    <p style="margin: 0; color: #2ecc71; font-weight: 700; font-size: 14px;">Logged in as <span id="githubUsername"></span></p>
                    <p style="margin: 0; color: var(--muted); font-size: 12px;">You can now submit and manage requests</p>
                  </div>
                </div>
                <button id="githubLogoutBtn" class="btn ghost small" type="button">Logout</button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="requestTitle">Title*</label>
            <input type="text" id="requestTitle" class="form-control" placeholder="Name of the game, etc." required>
          </div>
          <div class="form-group">
            <label for="requestCategory">Category*</label>
            <select id="requestCategory" class="form-control" required>
              <option value="">Select a category</option>
              <option value="Games">Games</option>
              <option value="Indie">Indie</option>
              <option value="AAA">AAA</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="requestLink">Link*</label>
            <input type="url" id="requestLink" class="form-control" placeholder="https://store.steampowered.com/app/..." required>
            <small style="display: block; margin-top: 4px; color: var(--muted);">Where can we find this game?</small>
          </div>
          <div class="form-group">
            <label for="requestDescription">Description</label>
            <textarea id="requestDescription" class="form-control" rows="4" placeholder="Provide any additional details..."></textarea>
          </div>
          <div class="form-actions" style="display:flex;gap:8px;align-items:center;">
            <button id="submitRequest" class="btn primary" type="button">Submit Request</button>
            <a href="https://github.com/LucyYuih/Games-that-fell-off-the-truck/issues" target="_blank" class="btn ghost">View All Requests</a>
          </div>
        </form>
        <div class="request-divider" style="height:18px;"></div>
        <h2>Requests</h2>
        <div class="request-view-tabs" style="display: flex; gap: 8px; margin: 12px 0;">
          <button class="request-view-tab active" id="allRequestsViewTab" type="button">All Requests</button>
          <button class="request-view-tab" id="myRequestsViewTab" style="display: none;" type="button">My Requests</button>
        </div>
        <div class="request-tabs" role="tablist" aria-label="Request status tabs" style="margin-bottom:12px;">
          <button class="request-tab active" id="openRequestsTab" type="button">Open</button>
          <button class="request-tab" id="closedRequestsTab" type="button">Closed</button>
        </div>
        <p id="requestsDescription" style="margin-bottom: 16px; color: var(--muted);">Coming Soon.</p>
        <div class="requests-grid" id="requestsGrid"></div>
      </section>
    </main>
    <div class="footer">@LucyYuih</div>
  </div>
<script>
const GAMES_BLOB = 'https://github.com/LucyYuih/Games-that-fell-off-the-truck/blob/main/games.txt';
const REPO = 'LucyYuih/Games-that-fell-off-the-truck';
const ISSUES_API = `https://api.github.com/repos/${REPO}/issues`;

function blobToRaw(blobUrl){
  try{
    const u = new URL(blobUrl);
    if(u.hostname.includes('github.com') && u.pathname.includes('/blob/')){
      const parts = u.pathname.split('/');
      const user = parts[1], repo = parts[2], branch = parts[4];
      const path = parts.slice(5).join('/');
      return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
    }
  }catch(e){}
  return blobUrl;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"'`]/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m];
  });
}
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
function parseGamesTxt(txt){
  const lines = txt.split(/\r?\n/);
  let currentCategory = null;
  const items = [], block = [];
  function flushBlock(){ if(block.length===0) return; const item=parseBlock(block,currentCategory); if(item) items.push(item); block=[]; }
  for(let i=0;i<lines.length;i++){
    const raw = lines[i];
    const line = raw.replace(/\u00A0/g,' ').trim();
    if(!line) continue;
    if(line.startsWith('#')) continue;
    const lower = line.toLowerCase();
    if(lower === 'games' || lower === 'indie' || lower === 'aaa'){ flushBlock(); currentCategory = capitalize(lower); continue; }
    if(/^[-]{3,}$/.test(line)) continue;
    if(line === '-') { flushBlock(); continue; }
    block.push(line);
  }
  flushBlock();
  return items;
}
function parseBlock(blockLines, currentCategory){
  const lines = blockLines.filter(l => l && l.trim() !== '');
  if(lines.length === 0) return null;
  const title = lines[0].trim();
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  let steamUrl = null;
  for(let i=1;i<lines.length;i++){
    const ln = lines[i].trim();
    if(ln.match(urlRegex) && ln.includes('steampowered.com/app/')) steamUrl = ln.match(urlRegex)[0];
  }
  let category = currentCategory || 'Games';
  return { title, category, steamUrl, rawLines: lines };
}
function makeCard(item){
  const el = document.createElement('div');
  el.className='card';
  el.dataset.title=item.title.toLowerCase();
  el.dataset.category=item.category;
  const thumb = document.createElement('div');
  thumb.className='thumb';
  if(item.steamUrl){
    const appIdMatch = item.steamUrl.match(/\/app\/(\d+)/);
    if(appIdMatch){
      const appId = appIdMatch[1];
      const img = document.createElement('img');
      img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/header.jpg`;
      img.alt = '';
      thumb.appendChild(img);
    }
    else{
      thumb.textContent = 'No Image';
    }
  }else{
    thumb.textContent = 'No Image';
  }
  const titleDiv = document.createElement('div');
  titleDiv.innerHTML = `<div class="title">${escapeHtml(item.title)}</div><div class="meta">${escapeHtml(item.category)}</div>`;
  const buttons = document.createElement('div');
  buttons.className='buttons';
  if(item.steamUrl){
    const aSteam = document.createElement('a');
    aSteam.className='btn primary';
    aSteam.href=item.steamUrl;
    aSteam.target='_blank';
    aSteam.rel='noopener';
    aSteam.textContent='Steam Page';
    buttons.appendChild(aSteam);
  }else{
    const no=document.createElement('div');
    no.className='btn ghost';
    no.textContent='No link';
    buttons.appendChild(no);
  }
  el.appendChild(thumb);
  el.appendChild(titleDiv);
  el.appendChild(buttons);
  return el;
}
function renderGrid(items){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  window.currentItems=items;
  const frag=document.createDocumentFragment();
  for(const it of items)
    frag.appendChild(makeCard(it));
  grid.appendChild(frag);
  filterAndShow();
}
function filterAndShow(){
  const query = (document.getElementById('search').value || '').toLowerCase();
  const cat = document.querySelector('.tab.active').dataset.cat;
  const grid = document.getElementById('grid');
  Array.from(grid.children).forEach(card => {
    const matchTitle = card.dataset.title.includes(query);
    const matchCat = (cat === 'all') || (card.dataset.category === cat);
    card.style.display = (matchTitle && matchCat) ? '' : 'none';
  });
}
function applySortAndReorder(){
  const sort = document.getElementById('sortSelect').value;
  const grid = document.getElementById('grid');
  let cards = Array.from(grid.children);
  if(sort === 'alpha'){
    cards = cards.sort((a,b)=>a.dataset.title.localeCompare(b.dataset.title));
  }
  grid.innerHTML = '';
  for(const card of cards) grid.appendChild(card);
  filterAndShow();
}
function applyColumns(cols){
  cols = Math.max(1, Math.min(8, parseInt(cols)));
  document.documentElement.style.setProperty('--cols', cols);
  localStorage.setItem('gridColumns', cols);
}
/* ---------------- REQUESTS LOGIC ------------------ */
let githubToken = null;
let githubUser = null;
function showLoginError(msg){
  document.getElementById('loginError').textContent = msg;
  document.getElementById('loginError').style.display = 'block';
}
function updateLoginUI(){
  if(githubUser){
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('loginSuccess').style.display = 'block';
    document.getElementById('githubUsername').textContent = githubUser.login;
    if(githubUser.avatar_url){
      document.getElementById('userAvatar').src = githubUser.avatar_url;
      document.getElementById('userAvatar').style.display = '';
      document.getElementById('defaultAvatar').style.display = 'none';
    }else{
      document.getElementById('userAvatar').style.display = 'none';
      document.getElementById('defaultAvatar').style.display = '';
    }
    document.getElementById('myRequestsViewTab').style.display = '';
  }else{
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('loginSuccess').style.display = 'none';
    document.getElementById('myRequestsViewTab').style.display = 'none';
  }
  document.getElementById('loginError').style.display = 'none';
}
async function authenticateWithGitHub(username, token){
  document.getElementById('loginSpinner').style.display = '';
  document.getElementById('githubLoginBtn').disabled = true;
  try{
    const res = await fetch('https://api.github.com/user', {
      headers: { Authorization: 'token ' + token }
    });
    if(!res.ok) throw new Error('Invalid token');
    githubUser = await res.json();
    githubToken = token;
    localStorage.setItem('github_token', token);
    localStorage.setItem('github_user', JSON.stringify(githubUser));
    updateLoginUI();
  }catch(e){
    showLoginError('GitHub authentication failed: ' + e.message);
  }
  document.getElementById('loginSpinner').style.display = 'none';
  document.getElementById('githubLoginBtn').disabled = false;
}
function switchRequestView(view){
  document.getElementById('allRequestsViewTab').classList.toggle('active', view === 'all');
  document.getElementById('myRequestsViewTab').classList.toggle('active', view === 'my');
  loadRequests(view);
}
function switchRequestStatus(status){
  document.getElementById('openRequestsTab').classList.toggle('active', status === 'open');
  document.getElementById('closedRequestsTab').classList.toggle('active', status === 'closed');
  loadRequests(null, status);
}
async function submitRequest(){
  if(!githubToken){
    showLoginError('You must be logged in to submit a request.');
    return;
  }
  const title = document.getElementById('requestTitle').value.trim();
  const category = document.getElementById('requestCategory').value.trim();
  const link = document.getElementById('requestLink').value.trim();
  const description = document.getElementById('requestDescription').value.trim();
  if(!title || !category || !link){
    showLoginError('Please fill in all required fields.');
    return;
  }
  const body = `**Category:** ${category}\n**Link:** ${link}\n\n${description}`;
  document.getElementById('submitRequest').disabled = true;
  try{
    const res = await fetch(ISSUES_API, {
      method: 'POST',
      headers: {
        Authorization: 'token ' + githubToken,
        Accept: 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({ title, body })
    });
    if(res.status === 201){
      document.getElementById('requestForm').reset();
      loadRequests();
      alert('Request submitted!');
    }else{
      const err = await res.json();
      showLoginError('Request failed: ' + (err.message || res.status));
    }
  }catch(e){
    showLoginError('Error submitting request: '+e.message);
  }
  document.getElementById('submitRequest').disabled = false;
}
async function loadRequests(view, status){
  const grid = document.getElementById('requestsGrid');
  grid.innerHTML = '<div style="color:#97a0ac;padding:20px;">Loading requests...</div>';
  let url = ISSUES_API + '?per_page=50&state=all';
  try{
    const res = await fetch(url);
    const issues = await res.json();
    let filtered = issues;
    if(status === 'open') filtered = issues.filter(i=>i.state==='open');
    if(status === 'closed') filtered = issues.filter(i=>i.state==='closed');
    if(view === 'my' && githubUser) filtered = filtered.filter(i=>i.user.login===githubUser.login);
    grid.innerHTML = '';
    for(const issue of filtered){
      grid.appendChild(makeRequestCard(issue));
    }
    if(filtered.length === 0) grid.innerHTML = '<div style="color:#97a0ac;padding:20px;">No requests found.</div>';
  }catch(e){
    grid.innerHTML = '<div style="color:#e74c3c;padding:20px;">Error loading requests: '+e.message+'</div>';
  }
}
function makeRequestCard(issue){
  const el = document.createElement('div');
  el.className = 'request-card';
  const statusClass = issue.state === 'open' ? 'status-open' : 'status-closed';
  el.innerHTML = `
    <div class="request-title">${escapeHtml(issue.title)}</div>
    <div class="request-meta">
      <span class="request-category">${extractCategory(issue.body)}</span>
      <a class="request-link" href="${extractLink(issue.body)}" target="_blank">Link</a>
      <span>by <b>${escapeHtml(issue.user.login)}</b></span>
    </div>
    <div class="request-body">${escapeHtml(extractDescription(issue.body))}</div>
    <div class="request-status ${statusClass}">${issue.state.toUpperCase()}</div>
    <a href="${issue.html_url}" target="_blank" style="color:${issue.state==='open'?'#7c5cf7':'#e74c3c'};font-size:13px;">View on GitHub</a>
  `;
  return el;
}
function extractCategory(body){
  const m = body.match(/\*\*Category:\*\*\s*([^\n]+)/);
  return m ? m[1] : "N/A";
}
function extractLink(body){
  const m = body.match(/\*\*Link:\*\*\s*(https?:\/\/[^\s]+)/);
  return m ? m[1] : "#";
}
function extractDescription(body){
  return body.replace(/\*\*Category:.*\*\*Link:.*\n*/s,'').trim();
}

/* --------- INIT --------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // MODAL
  if(localStorage.getItem('hideSiteWarningModal')!=='1'){
    document.getElementById('siteWarningModalOverlay').style.display='flex';
    document.getElementById('siteWarningModalOverlay').setAttribute('aria-hidden','false');
  }
  document.getElementById('siteWarningClose').onclick = ()=>{document.getElementById('siteWarningModalOverlay').style.display='none';};
  document.getElementById('siteWarningGotIt').onclick = ()=>{document.getElementById('siteWarningModalOverlay').style.display='none';};
  document.getElementById('siteWarningDontShow').onclick = ()=>{localStorage.setItem('hideSiteWarningModal','1');document.getElementById('siteWarningModalOverlay').style.display='none';};
  // GAMES GRID
  const raw = blobToRaw(GAMES_BLOB);
  fetch(raw).then(res=>res.text()).then(txt=>{renderGrid(parseGamesTxt(txt));});
  document.getElementById('sortSelect').addEventListener('change', applySortAndReorder);
  document.getElementById('search').addEventListener('input', filterAndShow);
  document.getElementById('tabs').addEventListener('click', (e) => {
    const b = e.target.closest('.tab');
    if(!b) return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const category = b.dataset.cat;
    if (category === 'requests') {
      document.getElementById('grid').style.display = 'none';
      document.getElementById('requestSection').style.display = 'block';
      loadRequests();
    } else {
      document.getElementById('grid').style.display = 'grid';
      document.getElementById('requestSection').style.display = 'none';
      filterAndShow();
    }
  });
  // Options
  const zoomSlider = document.getElementById('zoomSlider');
  const colsCount = document.getElementById('colsCount');
  if (zoomSlider) {
    zoomSlider.addEventListener('input', e => {
      applyColumns(e.target.value);
      colsCount.textContent = e.target.value;
    });
    // Init
    const savedCols = parseInt(localStorage.getItem('gridColumns') || getComputedStyle(document.documentElement).getPropertyValue('--cols') || 3, 10);
    zoomSlider.value = Math.min(8, Math.max(1, savedCols));
    colsCount.textContent = zoomSlider.value;
    applyColumns(zoomSlider.value);
  }
  const optionsBtn = document.getElementById('optionsBtn');
  const optionsMenu = document.getElementById('optionsMenu');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', ()=> {
      const isVisible = optionsMenu.classList.contains('show');
      if (isVisible) {
        optionsMenu.classList.remove('show');
        optionsMenu.setAttribute('aria-hidden', 'true');
      } else {
        optionsMenu.classList.add('show');
        optionsMenu.setAttribute('aria-hidden', 'false');
      }
    });
  }
  document.addEventListener('click', (e) => {
    if (optionsMenu && !optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
      optionsMenu.classList.remove('show');
      optionsMenu.setAttribute('aria-hidden', 'true');
    }
  });
  // Requests extras
  document.getElementById('submitRequest').addEventListener('click', submitRequest);
  document.getElementById('githubLoginBtn').addEventListener('click', async () => {
    const username = document.getElementById('githubUsernameInput').value.trim();
    const token = document.getElementById('githubTokenInput').value.trim();
    if (!username || !token) {
      showLoginError('Please enter both username and token');
      return;
    }
    await authenticateWithGitHub(username, token);
  });
  document.getElementById('githubLogoutBtn').addEventListener('click', () => {
    githubToken = null;
    githubUser = null;
    localStorage.removeItem('github_token');
    localStorage.removeItem('github_user');
    updateLoginUI();
    document.getElementById('myRequestsViewTab').style.display = 'none';
    switchRequestView('all');
  });
  document.getElementById('allRequestsViewTab').addEventListener('click', () => switchRequestView('all'));
  document.getElementById('myRequestsViewTab').addEventListener('click', () => switchRequestView('my'));
  document.getElementById('openRequestsTab').addEventListener('click', () => switchRequestStatus('open'));
  document.getElementById('closedRequestsTab').addEventListener('click', () => switchRequestStatus('closed'));
  // Restore login
  const savedToken = localStorage.getItem('github_token');
  const savedUser = localStorage.getItem('github_user');
  if(savedToken && savedUser){
    githubToken = savedToken;
    try{ githubUser = JSON.parse(savedUser); }catch(e){}
    updateLoginUI();
  }
});
</script>
</body>
</html>